# 后台启动错误修复指南

## 🐛 问题描述

Chrome扩展后台启动时出现WebSocket连接错误：
- **错误信息**: `net::ERR_CONNECTION_REFUSED`
- **连接地址**: `ws://localhost:3001/ws`
- **原因**: 后端服务未运行或WebSocket服务不可用

## 🔧 解决方案

### 1. 检查后端服务状态

**使用状态检查工具**：
打开 `browser-extension/test/test-backend-status.html` 检查服务状态

**手动检查**：
```bash
# 检查端口3001是否被占用
netstat -an | findstr :3001

# 或者直接访问健康检查端点
curl http://localhost:3001/health
```

### 2. 启动后端服务

```bash
# 进入后端目录
cd backend

# 安装依赖（首次运行）
npm install

# 启动服务
npm start
```

**预期输出**：
```
服务器运行在端口 3001
WebSocket服务地址: ws://localhost:3001/ws
```

### 3. 验证服务启动

**检查HTTP服务**：
- 浏览器访问: `http://localhost:3001/health`
- 应该返回: `{"status":"ok","timestamp":"..."}`

**检查WebSocket服务**：
- 浏览器访问: `http://localhost:3001/ws/status`
- 应该返回WebSocket连接统计信息

### 4. 修复扩展配置

**优化WebSocket连接逻辑**：
- ✅ 只在用户登录后才尝试连接
- ✅ 添加服务器可用性检查
- ✅ 改进错误处理和重连机制

**更新的连接流程**：
```
1. 扩展启动 → 检查登录状态
2. 如果已登录 → 检查服务器可用性
3. 如果服务器可用 → 建立WebSocket连接
4. 如果连接失败 → 智能重连（最多5次）
```

## 🧪 测试步骤

### 1. 启动所有服务
```bash
# 终端1: 启动后端
cd backend && npm start

# 终端2: 启动前端（可选）
cd web-client && npm run dev
```

### 2. 重新加载扩展
1. 打开 `chrome://extensions/`
2. 找到"书签密码同步助手"
3. 点击刷新按钮重新加载

### 3. 检查扩展状态
1. 打开扩展popup
2. 确认登录状态
3. 查看控制台是否还有错误

### 4. 测试WebSocket连接
1. 打开 `browser-extension/test/test-chrome-websocket.html`
2. 点击"检查WebSocket状态"
3. 应该显示"已连接"状态

## 🔍 故障排除

### 问题1: 端口被占用
**症状**: `EADDRINUSE: address already in use :::3001`
**解决**:
```bash
# Windows
netstat -ano | findstr :3001
taskkill /PID <PID> /F

# 或者更改端口
# 在backend/.env中设置: PORT=3002
```

### 问题2: 权限问题
**症状**: `EACCES: permission denied`
**解决**:
```bash
# 以管理员身份运行命令行
# 或者使用不同的端口号（如8001）
```

### 问题3: 依赖缺失
**症状**: `Cannot find module 'ws'`
**解决**:
```bash
cd backend
npm install
```

### 问题4: 环境变量问题
**症状**: JWT_SECRET或其他环境变量未定义
**解决**:
```bash
# 检查backend/.env文件是否存在
# 复制.env.example为.env
cp .env.example .env
```

## 📋 完整启动检查清单

- [ ] 后端服务正常启动（端口3001）
- [ ] HTTP健康检查通过
- [ ] WebSocket服务可用
- [ ] 扩展已重新加载
- [ ] 用户已登录扩展
- [ ] WebSocket连接状态正常
- [ ] 控制台无连接错误

## 🔧 预防措施

### 1. 自动启动脚本
创建 `start-all-services.bat`:
```batch
@echo off
echo 启动所有服务...

start "Backend" cmd /k "cd backend && npm start"
timeout /t 3
start "Frontend" cmd /k "cd web-client && npm run dev"

echo 所有服务已启动！
pause
```

### 2. 服务监控
- 使用 `browser-extension/test/test-backend-status.html` 定期检查
- 设置开发环境自动启动脚本
- 配置IDE任务自动启动服务

### 3. 错误日志
- 检查后端控制台输出
- 查看Chrome扩展控制台
- 使用测试页面的详细日志

## ✅ 修复验证

修复成功的标志：
1. 后端服务正常启动无错误
2. Chrome扩展加载无WebSocket错误
3. 扩展popup显示正常连接状态
4. 书签同步功能正常工作

按照此指南操作后，WebSocket连接错误应该得到解决！🎉