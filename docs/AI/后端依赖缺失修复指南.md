# 后端依赖缺失修复指南

## 🐛 问题描述

后端启动失败，错误信息：
```
Error: Cannot find module 'ws'
```

**原因**: 后端代码使用了WebSocket功能，但`package.json`中缺少`ws`依赖包。

## 🔧 快速修复

### 方法1: 使用修复脚本（推荐）
```bash
# 双击运行修复脚本
fix-backend-dependencies.bat
```

### 方法2: 手动修复
```bash
# 进入后端目录
cd backend

# 安装缺失的ws依赖
npm install ws@^8.14.2

# 重新安装所有依赖
npm install
```

### 方法3: 使用更新的启动脚本
```bash
# 新的启动脚本会自动检查并安装依赖
start-all-services.bat
```

## 📋 修复步骤详解

### 1. 确认问题
检查错误信息是否包含：
- `Cannot find module 'ws'`
- `MODULE_NOT_FOUND`
- 文件路径指向`websocket.js`

### 2. 安装依赖
```bash
cd backend
npm install ws@^8.14.2
```

### 3. 验证安装
检查`node_modules`目录下是否有`ws`文件夹：
```bash
dir node_modules\ws
```

### 4. 重新启动
```bash
npm start
```

### 5. 验证成功
看到以下输出表示成功：
```
服务器运行在端口 3001
WebSocket服务地址: ws://localhost:3001/ws
```

## 🔍 其他可能的依赖问题

如果还有其他模块缺失，可能需要安装：

```bash
# 安装所有项目依赖
npm install

# 或者单独安装特定依赖
npm install express cors helmet jsonwebtoken
```

## 📁 更新的package.json

已更新的`backend/package.json`包含了`ws`依赖：

```json
{
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "cors": "^2.8.5",
    "crypto-js": "^4.1.1",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "express-rate-limit": "^6.10.0",
    "helmet": "^7.0.0",
    "joi": "^17.9.2",
    "jsonwebtoken": "^9.0.2",
    "knex": "^2.5.1",
    "multer": "^2.0.2",
    "pg": "^8.11.3",
    "ws": "^8.14.2"
  }
}
```

## 🚀 验证修复

### 1. 启动后端
```bash
cd backend
npm start
```

### 2. 检查输出
应该看到：
```
✅ 服务器运行在端口 3001
✅ WebSocket服务地址: ws://localhost:3001/ws
```

### 3. 测试连接
- 浏览器访问: `http://localhost:3001/health`
- 应该返回: `{"status":"ok","timestamp":"..."}`

### 4. 测试WebSocket
- 浏览器访问: `http://localhost:3001/ws/status`
- 应该返回WebSocket连接统计信息

## 🔧 预防措施

### 1. 完整的依赖检查
创建依赖检查脚本：
```bash
# check-dependencies.bat
@echo off
cd backend
echo 检查依赖...
npm list ws
if errorlevel 1 (
    echo 安装缺失依赖...
    npm install
)
```

### 2. 开发环境设置
确保开发环境包含所有必要工具：
- Node.js (推荐v16+)
- npm (推荐v8+)
- 稳定的网络连接

### 3. 依赖锁定
使用`package-lock.json`确保依赖版本一致：
```bash
npm ci  # 使用锁定的依赖版本
```

## ⚠️ 常见问题

### 问题1: npm install失败
**解决**: 清除缓存后重试
```bash
npm cache clean --force
npm install
```

### 问题2: 权限问题
**解决**: 以管理员身份运行命令行
```bash
# 右键点击命令提示符 -> "以管理员身份运行"
```

### 问题3: 网络问题
**解决**: 使用国内镜像
```bash
npm config set registry https://registry.npmmirror.com/
npm install
```

### 问题4: Node.js版本过低
**解决**: 升级Node.js到v16+
```bash
node --version  # 检查版本
# 如果版本过低，请从官网下载最新版本
```

## ✅ 修复验证清单

- [ ] `ws`依赖已安装
- [ ] `npm start`无错误
- [ ] 后端服务正常启动
- [ ] WebSocket服务可用
- [ ] 健康检查通过
- [ ] Chrome扩展可以连接

修复完成后，后端服务应该能够正常启动，WebSocket功能也能正常工作！🎉

## 🔄 下一步

1. 启动后端服务
2. 重新加载Chrome扩展
3. 测试WebSocket连接
4. 验证实时同步功能