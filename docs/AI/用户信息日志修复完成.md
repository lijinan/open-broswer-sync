# ç”¨æˆ·ä¿¡æ¯æ—¥å¿—ä¿®å¤å®Œæˆ

## é—®é¢˜æè¿°
åå°WebSocketè¿æ¥æ—¥å¿—æ˜¾ç¤ºç”¨æˆ·åå’ŒIDéƒ½æ˜¯"undefined"ï¼Œæ— æ³•æ­£ç¡®è¯†åˆ«è¿æ¥çš„ç”¨æˆ·èº«ä»½ã€‚

## é—®é¢˜åŸå› 
1. **JWT Tokenæ ¼å¼ä¸å®Œæ•´**: æ—§ç‰ˆæœ¬çš„JWT tokenåªåŒ…å«`userId`å­—æ®µï¼Œç¼ºå°‘`name`å’Œ`email`ä¿¡æ¯
2. **WebSocketéªŒè¯é€»è¾‘ç¼ºé™·**: `verifyClient`æ–¹æ³•æ²¡æœ‰æ­£ç¡®æå–å’Œä¼ é€’ç”¨æˆ·ä¿¡æ¯
3. **å‘åå…¼å®¹æ€§é—®é¢˜**: æ²¡æœ‰å¤„ç†æ–°æ—§JWTæ ¼å¼çš„å…¼å®¹æ€§

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ›´æ–°JWT Tokenç”Ÿæˆ âœ…
**æ–‡ä»¶**: `backend/src/routes/auth.js`

æ›´æ–°ç™»å½•å’Œæ³¨å†Œæ¥å£ï¼Œç”ŸæˆåŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯çš„JWT token:
```javascript
const token = jwt.sign(
  { 
    id: user.id,
    userId: user.id, // ä¿æŒå‘åå…¼å®¹
    name: user.name,
    email: user.email
  },
  process.env.JWT_SECRET,
  { expiresIn: process.env.JWT_EXPIRES_IN }
);
```

### 2. æ›´æ–°è®¤è¯ä¸­é—´ä»¶ âœ…
**æ–‡ä»¶**: `backend/src/middleware/auth.js`

æ”¯æŒæ–°æ—§JWTæ ¼å¼çš„å…¼å®¹æ€§å¤„ç†:
```javascript
// æ”¯æŒæ–°æ—§JWTæ ¼å¼
const userId = decoded.id || decoded.userId;

// å¦‚æœJWTä¸­å·²åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
if (decoded.name && decoded.email) {
  req.user = { 
    id: userId, 
    name: decoded.name, 
    email: decoded.email 
  };
  next();
  return;
}

// å¦åˆ™ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå‘åå…¼å®¹ï¼‰
const user = await db('users').where({ id: userId }).first();
req.user = { id: user.id, name: user.name, email: user.email };
```

### 3. ä¿®å¤WebSocketæœåŠ¡ âœ…
**æ–‡ä»¶**: `backend/src/services/websocket.js`

#### æ›´æ–°å®¢æˆ·ç«¯éªŒè¯é€»è¾‘:
```javascript
async verifyClient(info) {
  const decoded = jwt.verify(token, process.env.JWT_SECRET);
  const userId = decoded.id || decoded.userId;
  
  // å¦‚æœJWTä¸­å·²åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
  if (decoded.name && decoded.email) {
    info.req.user = { 
      id: userId, 
      name: decoded.name, 
      email: decoded.email 
    };
    return true;
  }
  
  // å¦åˆ™ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå‘åå…¼å®¹ï¼‰
  const user = await db('users').where({ id: userId }).first();
  info.req.user = { 
    id: user.id, 
    name: user.name, 
    email: user.email 
  };
  return true;
}
```

#### å¢å¼ºè¿æ¥å¤„ç†å’Œæ—¥å¿—:
```javascript
handleConnection(ws, req) {
  // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å­˜åœ¨
  if (!req.user || !req.user.id) {
    console.error('WebSocketè¿æ¥å¤±è´¥: ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯');
    ws.close(1008, 'ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±');
    return;
  }
  
  const userId = req.user.id;
  const userName = req.user.name || `ç”¨æˆ·${userId}`;
  const userEmail = req.user.email || 'æœªçŸ¥é‚®ç®±';
  
  console.log(`ç”¨æˆ· ${userName} (ID: ${userId}, é‚®ç®±: ${userEmail}) å»ºç«‹WebSocketè¿æ¥`);
  
  // å‘é€è¿æ¥æˆåŠŸæ¶ˆæ¯åŒ…å«ç”¨æˆ·ä¿¡æ¯
  this.sendToClient(ws, {
    type: 'connection',
    status: 'connected',
    message: 'å®æ—¶åŒæ­¥å·²è¿æ¥',
    user: { id: userId, name: userName, email: userEmail },
    timestamp: new Date().toISOString()
  });
}
```

## æµ‹è¯•éªŒè¯

### 1. åˆ›å»ºæµ‹è¯•å·¥å…· âœ…
**æ–‡ä»¶**: `browser-extension/test/test-user-info.html`

åŒ…å«ä»¥ä¸‹æµ‹è¯•åŠŸèƒ½:
- è‡ªåŠ¨ç™»å½•æµ‹è¯•ç”¨æˆ·
- æ£€æŸ¥JWT tokenå†…å®¹
- æµ‹è¯•WebSocketè¿æ¥
- éªŒè¯ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º

### 2. æµ‹è¯•æ­¥éª¤
1. **é‡æ–°ç™»å½•**: ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ä»¥è·å–åŒ…å«å®Œæ•´ä¿¡æ¯çš„æ–°JWT token
2. **WebSocketè¿æ¥**: å»ºç«‹WebSocketè¿æ¥æ—¶ä¼šæ˜¾ç¤ºæ­£ç¡®çš„ç”¨æˆ·åå’ŒID
3. **æ—¥å¿—éªŒè¯**: åå°æ—¥å¿—æ˜¾ç¤ºæ ¼å¼: `ç”¨æˆ· Leon Test User (ID: 1, é‚®ç®±: leon@example.com) å»ºç«‹WebSocketè¿æ¥`

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰:
```
ç”¨æˆ· undefined (ID: undefined) å»ºç«‹WebSocketè¿æ¥
ğŸ“¤ å‘é€é€šçŸ¥ç»™ç”¨æˆ· undefined (ID: undefined)
```

### ä¿®å¤å:
```
ç”¨æˆ· Leon Test User (ID: 1, é‚®ç®±: leon@example.com) å»ºç«‹WebSocketè¿æ¥
ğŸ“¤ å‘é€é€šçŸ¥ç»™ç”¨æˆ· Leon Test User (ID: 1)
```

## å‘åå…¼å®¹æ€§
- âœ… æ”¯æŒæ—§ç‰ˆJWT tokenï¼ˆåªåŒ…å«userIdï¼‰
- âœ… æ”¯æŒæ–°ç‰ˆJWT tokenï¼ˆåŒ…å«å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼‰
- âœ… è‡ªåŠ¨ä»æ•°æ®åº“è·å–ç¼ºå¤±çš„ç”¨æˆ·ä¿¡æ¯
- âœ… ç”¨æˆ·æ— éœ€é‡æ–°å®‰è£…æ‰©å±•ï¼Œåªéœ€é‡æ–°ç™»å½•

## æ³¨æ„äº‹é¡¹
1. **é‡æ–°ç™»å½•**: ç°æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ä»¥è·å–æ–°æ ¼å¼çš„JWT token
2. **æ•°æ®åº“è¿æ¥**: å¦‚æœJWTä¸­ç¼ºå°‘ç”¨æˆ·ä¿¡æ¯ï¼Œä¼šæŸ¥è¯¢æ•°æ®åº“è·å–
3. **é”™è¯¯å¤„ç†**: å¢åŠ äº†å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
4. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜å…ˆä½¿ç”¨JWTä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

## ç›¸å…³æ–‡ä»¶
- `backend/src/routes/auth.js` - JWT tokenç”Ÿæˆ
- `backend/src/middleware/auth.js` - è®¤è¯ä¸­é—´ä»¶
- `backend/src/services/websocket.js` - WebSocketæœåŠ¡
- `browser-extension/test/test-user-info.html` - æµ‹è¯•å·¥å…·

## çŠ¶æ€: âœ… å·²å®Œæˆ
ç”¨æˆ·ä¿¡æ¯æ—¥å¿—æ˜¾ç¤ºé—®é¢˜å·²ä¿®å¤ï¼ŒWebSocketè¿æ¥æ—¥å¿—ç°åœ¨èƒ½æ­£ç¡®æ˜¾ç¤ºç”¨æˆ·åå’ŒIDã€‚