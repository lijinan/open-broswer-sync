<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .instructions {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #0066cc;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å®æ—¶åŒæ­¥æµ‹è¯•é¡µé¢</h1>
        
        <div class="instructions">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <ol>
                <li>ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ (http://localhost:3001)</li>
                <li>ç¡®ä¿æµè§ˆå™¨æ‰©å±•å·²å®‰è£…å¹¶ç™»å½•</li>
                <li>æ‰“å¼€å¤šä¸ªæµè§ˆå™¨çª—å£æˆ–ä¸åŒæµè§ˆå™¨è¿›è¡Œæµ‹è¯•</li>
                <li>åœ¨ä¸€ä¸ªæµè§ˆå™¨ä¸­æ·»åŠ /åˆ é™¤"åŒæ­¥æ”¶è—å¤¹"ä¸­çš„ä¹¦ç­¾</li>
                <li>è§‚å¯Ÿå…¶ä»–æµè§ˆå™¨æ˜¯å¦æ”¶åˆ°å®æ—¶åŒæ­¥é€šçŸ¥</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ”— WebSocketè¿æ¥çŠ¶æ€</h3>
            <div id="connectionStatus" class="status disconnected">æœªè¿æ¥</div>
            <button onclick="checkConnectionStatus()">æ£€æŸ¥è¿æ¥çŠ¶æ€</button>
            <button onclick="connectWebSocket()">è¿æ¥WebSocket</button>
            <button onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“š ä¹¦ç­¾åŒæ­¥æµ‹è¯•</h3>
            <p>åœ¨æµè§ˆå™¨çš„"åŒæ­¥æ”¶è—å¤¹"ä¸­æ·»åŠ æˆ–åˆ é™¤ä¹¦ç­¾ï¼Œè§‚å¯Ÿå®æ—¶åŒæ­¥æ•ˆæœã€‚</p>
            <button onclick="createTestBookmark()">åˆ›å»ºæµ‹è¯•ä¹¦ç­¾</button>
            <button onclick="deleteTestBookmark()">åˆ é™¤æµ‹è¯•ä¹¦ç­¾</button>
            <button onclick="clearSyncFolder()">æ¸…ç©ºåŒæ­¥æ”¶è—å¤¹</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æ‰©å±•çŠ¶æ€</h3>
            <button onclick="checkExtensionStatus()">æ£€æŸ¥æ‰©å±•çŠ¶æ€</button>
            <button onclick="checkLoginStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
            <button onclick="testNotification()">æµ‹è¯•é€šçŸ¥</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logContainer" class="log"></div>
        </div>
    </div>

    <script>
        let logContainer;
        let connectionStatusElement;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            connectionStatusElement = document.getElementById('connectionStatus');
            
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
            checkConnectionStatus();
            
            // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
            setInterval(checkConnectionStatus, 5000);
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(message);
        }

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnectionStatus() {
            try {
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    const response = await chrome.runtime.sendMessage({
                        type: 'WEBSOCKET_STATUS'
                    });
                    
                    updateConnectionStatus(response.status);
                } else {
                    updateConnectionStatus('extension_not_available');
                }
            } catch (error) {
                log('âŒ æ£€æŸ¥è¿æ¥çŠ¶æ€å¤±è´¥: ' + error.message);
                updateConnectionStatus('error');
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(status) {
            if (!connectionStatusElement) return;
            
            connectionStatusElement.className = 'status';
            
            switch (status) {
                case 'connected':
                    connectionStatusElement.className += ' connected';
                    connectionStatusElement.textContent = 'âœ… å·²è¿æ¥';
                    break;
                case 'connecting':
                    connectionStatusElement.className += ' connecting';
                    connectionStatusElement.textContent = 'ğŸ”„ è¿æ¥ä¸­...';
                    break;
                case 'disconnected':
                    connectionStatusElement.className += ' disconnected';
                    connectionStatusElement.textContent = 'âŒ æœªè¿æ¥';
                    break;
                case 'not_initialized':
                    connectionStatusElement.className += ' disconnected';
                    connectionStatusElement.textContent = 'âš ï¸ æœªåˆå§‹åŒ–';
                    break;
                case 'extension_not_available':
                    connectionStatusElement.className += ' disconnected';
                    connectionStatusElement.textContent = 'âŒ æ‰©å±•ä¸å¯ç”¨';
                    break;
                default:
                    connectionStatusElement.className += ' disconnected';
                    connectionStatusElement.textContent = 'â“ æœªçŸ¥çŠ¶æ€: ' + status;
            }
        }

        // è¿æ¥WebSocket
        async function connectWebSocket() {
            try {
                log('ğŸ”„ å°è¯•è¿æ¥WebSocket...');
                
                const response = await chrome.runtime.sendMessage({
                    type: 'WEBSOCKET_CONNECT'
                });
                
                if (response.success) {
                    log('âœ… WebSocketè¿æ¥è¯·æ±‚å·²å‘é€');
                    setTimeout(checkConnectionStatus, 1000);
                } else {
                    log('âŒ WebSocketè¿æ¥è¯·æ±‚å¤±è´¥');
                }
            } catch (error) {
                log('âŒ è¿æ¥WebSocketå¤±è´¥: ' + error.message);
            }
        }

        // æ–­å¼€WebSocket
        async function disconnectWebSocket() {
            try {
                log('ğŸ”„ æ–­å¼€WebSocketè¿æ¥...');
                
                const response = await chrome.runtime.sendMessage({
                    type: 'WEBSOCKET_DISCONNECT'
                });
                
                if (response.success) {
                    log('âœ… WebSocketå·²æ–­å¼€');
                    setTimeout(checkConnectionStatus, 1000);
                } else {
                    log('âŒ æ–­å¼€WebSocketå¤±è´¥');
                }
            } catch (error) {
                log('âŒ æ–­å¼€WebSocketå¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºæµ‹è¯•ä¹¦ç­¾
        async function createTestBookmark() {
            try {
                log('ğŸ“š åˆ›å»ºæµ‹è¯•ä¹¦ç­¾...');
                
                // é¦–å…ˆæŸ¥æ‰¾æˆ–åˆ›å»º"åŒæ­¥æ”¶è—å¤¹"
                const syncFolders = await chrome.bookmarks.search({title: 'åŒæ­¥æ”¶è—å¤¹'});
                let syncFolderId;
                
                if (syncFolders.length === 0) {
                    log('ğŸ“ åˆ›å»º"åŒæ­¥æ”¶è—å¤¹"...');
                    const folder = await chrome.bookmarks.create({
                        title: 'åŒæ­¥æ”¶è—å¤¹'
                    });
                    syncFolderId = folder.id;
                } else {
                    syncFolderId = syncFolders[0].id;
                }
                
                // åˆ›å»ºæµ‹è¯•ä¹¦ç­¾
                const timestamp = new Date().toLocaleTimeString();
                const bookmark = await chrome.bookmarks.create({
                    parentId: syncFolderId,
                    title: `æµ‹è¯•ä¹¦ç­¾ ${timestamp}`,
                    url: `https://example.com/test-${Date.now()}`
                });
                
                log(`âœ… æµ‹è¯•ä¹¦ç­¾å·²åˆ›å»º: ${bookmark.title}`);
            } catch (error) {
                log('âŒ åˆ›å»ºæµ‹è¯•ä¹¦ç­¾å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤æµ‹è¯•ä¹¦ç­¾
        async function deleteTestBookmark() {
            try {
                log('ğŸ—‘ï¸ æŸ¥æ‰¾å¹¶åˆ é™¤æµ‹è¯•ä¹¦ç­¾...');
                
                const bookmarks = await chrome.bookmarks.search({title: 'æµ‹è¯•ä¹¦ç­¾'});
                const testBookmarks = bookmarks.filter(b => b.title.startsWith('æµ‹è¯•ä¹¦ç­¾'));
                
                if (testBookmarks.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°æµ‹è¯•ä¹¦ç­¾');
                    return;
                }
                
                for (const bookmark of testBookmarks) {
                    await chrome.bookmarks.remove(bookmark.id);
                    log(`âœ… å·²åˆ é™¤æµ‹è¯•ä¹¦ç­¾: ${bookmark.title}`);
                }
            } catch (error) {
                log('âŒ åˆ é™¤æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…ç©ºåŒæ­¥æ”¶è—å¤¹
        async function clearSyncFolder() {
            try {
                if (!confirm('ç¡®å®šè¦æ¸…ç©º"åŒæ­¥æ”¶è—å¤¹"ä¸­çš„æ‰€æœ‰ä¹¦ç­¾å—ï¼Ÿ')) {
                    return;
                }
                
                log('ğŸ—‘ï¸ æ¸…ç©ºåŒæ­¥æ”¶è—å¤¹...');
                
                const syncFolders = await chrome.bookmarks.search({title: 'åŒæ­¥æ”¶è—å¤¹'});
                if (syncFolders.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"');
                    return;
                }
                
                const children = await chrome.bookmarks.getChildren(syncFolders[0].id);
                let deletedCount = 0;
                
                for (const child of children) {
                    if (child.url) { // åªåˆ é™¤ä¹¦ç­¾ï¼Œä¸åˆ é™¤å­æ–‡ä»¶å¤¹
                        await chrome.bookmarks.remove(child.id);
                        deletedCount++;
                    }
                }
                
                log(`âœ… å·²æ¸…ç©ºåŒæ­¥æ”¶è—å¤¹ï¼Œåˆ é™¤äº† ${deletedCount} ä¸ªä¹¦ç­¾`);
            } catch (error) {
                log('âŒ æ¸…ç©ºåŒæ­¥æ”¶è—å¤¹å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥æ‰©å±•çŠ¶æ€
        async function checkExtensionStatus() {
            try {
                log('ğŸ” æ£€æŸ¥æ‰©å±•çŠ¶æ€...');
                
                const settings = await chrome.runtime.sendMessage({
                    type: 'GET_SETTINGS'
                });
                
                log('âš™ï¸ æ‰©å±•è®¾ç½®: ' + JSON.stringify(settings, null, 2));
            } catch (error) {
                log('âŒ æ£€æŸ¥æ‰©å±•çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                log('ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€...');
                
                const status = await chrome.runtime.sendMessage({
                    type: 'CHECK_LOGIN_STATUS'
                });
                
                if (status.loggedIn) {
                    log('âœ… å·²ç™»å½•: ' + JSON.stringify(status.user));
                } else {
                    log('âŒ æœªç™»å½•: ' + (status.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                log('âŒ æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•é€šçŸ¥
        async function testNotification() {
            try {
                log('ğŸ”” å‘é€æµ‹è¯•é€šçŸ¥...');
                
                const response = await chrome.runtime.sendMessage({
                    type: 'TEST_NOTIFICATION',
                    message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ - ' + new Date().toLocaleTimeString()
                });
                
                if (response.success) {
                    log('âœ… æµ‹è¯•é€šçŸ¥å·²å‘é€');
                } else {
                    log('âŒ å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥');
                }
            } catch (error) {
                log('âŒ å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('ğŸ“„ æ—¥å¿—å·²æ¸…ç©º');
        }
    </script>
</body>
</html>