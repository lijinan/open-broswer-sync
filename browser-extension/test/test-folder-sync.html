<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶å¤¹åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .folder-tree {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ–‡ä»¶å¤¹åŒæ­¥æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•ç›®æ ‡</h3>
            <p><strong>é—®é¢˜</strong>: ä¹¦ç­¾åŒæ­¥åˆ°äº†"åŒæ­¥æ”¶è—å¤¹"æ ¹ç›®å½•ï¼Œæ²¡æœ‰åŒæ­¥åˆ°å¯¹åº”çš„å­æ–‡ä»¶å¤¹</p>
            <p><strong>ä¿®å¤</strong>: è§£ææ–‡ä»¶å¤¹è·¯å¾„ï¼Œè‡ªåŠ¨åˆ›å»º/æŸ¥æ‰¾å¯¹åº”çš„å­æ–‡ä»¶å¤¹ç»“æ„</p>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ æµ‹è¯•æ“ä½œ</h3>
            <button onclick="testWebSocketConnection()">æµ‹è¯•WebSocketè¿æ¥</button>
            <button onclick="showCurrentStructure()">æ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹ç»“æ„</button>
            <button onclick="createTestFolders()">åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹ç»“æ„</button>
            <button onclick="testFolderSync()">æµ‹è¯•æ–‡ä»¶å¤¹åŒæ­¥</button>
            <button onclick="cleanupTestData()">æ¸…ç†æµ‹è¯•æ•°æ®</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‚ å½“å‰æ–‡ä»¶å¤¹ç»“æ„</h3>
            <div id="folderStructure" class="folder-tree">ç‚¹å‡»"æ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹ç»“æ„"æŸ¥çœ‹</div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logContainer" class="log"></div>
        </div>
    </div>

    <script>
        let logContainer;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            log('ğŸ“„ æ–‡ä»¶å¤¹åŒæ­¥æµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            // è‡ªåŠ¨æ˜¾ç¤ºå½“å‰ç»“æ„
            setTimeout(showCurrentStructure, 1000);
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(message);
        }

        // æµ‹è¯•WebSocketè¿æ¥
        async function testWebSocketConnection() {
            try {
                log('ğŸ”Œ æµ‹è¯•WebSocketè¿æ¥...');
                
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                const wsUrl = serverUrl.replace('http', 'ws') + `/ws?token=${settings.token}`;
                
                log('ğŸ”— è¿æ¥åœ°å€: ' + wsUrl);
                
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    
                    // è®¢é˜…ä¹¦ç­¾æ›´æ–°
                    ws.send(JSON.stringify({
                        type: 'subscribe',
                        subscriptions: ['bookmarks']
                    }));
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message.type} - ${JSON.stringify(message)}`);
                };
                
                ws.onclose = (event) => {
                    log(`ğŸ”Œ WebSocketè¿æ¥å…³é—­: ${event.code} - ${event.reason}`);
                };
                
                ws.onerror = (error) => {
                    log('âŒ WebSocketé”™è¯¯: ' + error);
                };
                
                // 10ç§’åå…³é—­è¿æ¥
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                        log('ğŸ”Œ ä¸»åŠ¨å…³é—­WebSocketè¿æ¥');
                    }
                }, 10000);
                
            } catch (error) {
                log('âŒ WebSocketè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹ç»“æ„
        async function showCurrentStructure() {
            try {
                log('ğŸ” æ˜¾ç¤ºå½“å‰æ–‡ä»¶å¤¹ç»“æ„...');
                
                const syncFolders = await chrome.bookmarks.search({title: 'åŒæ­¥æ”¶è—å¤¹'});
                if (syncFolders.length === 0) {
                    log('âŒ æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"');
                    document.getElementById('folderStructure').textContent = 'æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"';
                    return;
                }
                
                const syncFolder = syncFolders[0];
                log('âœ… æ‰¾åˆ°åŒæ­¥æ”¶è—å¤¹: ' + syncFolder.id);
                
                const structure = await buildFolderTree(syncFolder.id, 0);
                document.getElementById('folderStructure').textContent = structure;
                
            } catch (error) {
                log('âŒ æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æ„å¤±è´¥: ' + error.message);
            }
        }

        // é€’å½’æ„å»ºæ–‡ä»¶å¤¹æ ‘
        async function buildFolderTree(folderId, depth) {
            const indent = '  '.repeat(depth);
            let result = '';
            
            try {
                const children = await chrome.bookmarks.getChildren(folderId);
                
                for (const child of children) {
                    if (child.url) {
                        // ä¹¦ç­¾
                        result += `${indent}ğŸ“„ ${child.title} (${child.url})\n`;
                    } else {
                        // æ–‡ä»¶å¤¹
                        result += `${indent}ğŸ“ ${child.title}/\n`;
                        const subTree = await buildFolderTree(child.id, depth + 1);
                        result += subTree;
                    }
                }
                
            } catch (error) {
                result += `${indent}âŒ è¯»å–å¤±è´¥: ${error.message}\n`;
            }
            
            return result;
        }

        // åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹ç»“æ„
        async function createTestFolders() {
            try {
                log('ğŸ“ åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹ç»“æ„...');
                
                // æŸ¥æ‰¾åŒæ­¥æ”¶è—å¤¹
                const syncFolders = await chrome.bookmarks.search({title: 'åŒæ­¥æ”¶è—å¤¹'});
                let syncFolderId;
                
                if (syncFolders.length === 0) {
                    log('ğŸ“ åˆ›å»º"åŒæ­¥æ”¶è—å¤¹"...');
                    const folder = await chrome.bookmarks.create({
                        title: 'åŒæ­¥æ”¶è—å¤¹'
                    });
                    syncFolderId = folder.id;
                } else {
                    syncFolderId = syncFolders[0].id;
                }
                
                // åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹ç»“æ„
                const testFolders = [
                    'ä¸ªäººèµ„æ–™',
                    'å·¥ä½œ',
                    'å­¦ä¹ ',
                    'ä¸ªäººèµ„æ–™/ç¤¾äº¤åª’ä½“',
                    'ä¸ªäººèµ„æ–™/è´­ç‰©',
                    'å·¥ä½œ/é¡¹ç›®A',
                    'å·¥ä½œ/é¡¹ç›®B',
                    'å­¦ä¹ /ç¼–ç¨‹',
                    'å­¦ä¹ /è®¾è®¡'
                ];
                
                for (const folderPath of testFolders) {
                    await ensureFolderExists(syncFolderId, folderPath);
                }
                
                log('âœ… æµ‹è¯•æ–‡ä»¶å¤¹ç»“æ„åˆ›å»ºå®Œæˆ');
                
                // åˆ·æ–°æ˜¾ç¤º
                setTimeout(showCurrentStructure, 1000);
                
            } catch (error) {
                log('âŒ åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
            }
        }

        // ç¡®ä¿æ–‡ä»¶å¤¹å­˜åœ¨
        async function ensureFolderExists(syncFolderId, folderPath) {
            const pathParts = folderPath.split('/');
            let currentFolderId = syncFolderId;
            
            for (const folderName of pathParts) {
                if (!folderName.trim()) continue;
                
                // æŸ¥æ‰¾ç°æœ‰æ–‡ä»¶å¤¹
                const children = await chrome.bookmarks.getChildren(currentFolderId);
                let targetFolder = children.find(child => !child.url && child.title === folderName);
                
                if (targetFolder) {
                    log(`âœ… æ‰¾åˆ°ç°æœ‰æ–‡ä»¶å¤¹: ${folderName}`);
                    currentFolderId = targetFolder.id;
                } else {
                    // åˆ›å»ºæ–°æ–‡ä»¶å¤¹
                    log(`ğŸ“ åˆ›å»ºæ–‡ä»¶å¤¹: ${folderName}`);
                    const newFolder = await chrome.bookmarks.create({
                        title: folderName,
                        parentId: currentFolderId
                    });
                    currentFolderId = newFolder.id;
                }
            }
            
            return currentFolderId;
        }

        // æµ‹è¯•æ–‡ä»¶å¤¹åŒæ­¥
        async function testFolderSync() {
            try {
                log('ğŸ§ª æµ‹è¯•æ–‡ä»¶å¤¹åŒæ­¥åŠŸèƒ½...');
                
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                    return;
                }
                
                // æµ‹è¯•ä¸åŒæ–‡ä»¶å¤¹è·¯å¾„çš„ä¹¦ç­¾åˆ›å»º
                const testBookmarks = [
                    {
                        title: 'æµ‹è¯•ä¹¦ç­¾-æ ¹ç›®å½•',
                        url: 'https://example.com/root',
                        folder: 'åŒæ­¥æ”¶è—å¤¹'
                    },
                    {
                        title: 'æµ‹è¯•ä¹¦ç­¾-ä¸ªäººèµ„æ–™',
                        url: 'https://example.com/personal',
                        folder: 'åŒæ­¥æ”¶è—å¤¹ > ä¸ªäººèµ„æ–™'
                    },
                    {
                        title: 'æµ‹è¯•ä¹¦ç­¾-å·¥ä½œé¡¹ç›®A',
                        url: 'https://example.com/work-a',
                        folder: 'åŒæ­¥æ”¶è—å¤¹ > å·¥ä½œ > é¡¹ç›®A'
                    },
                    {
                        title: 'æµ‹è¯•ä¹¦ç­¾-å­¦ä¹ ç¼–ç¨‹',
                        url: 'https://example.com/learning',
                        folder: 'åŒæ­¥æ”¶è—å¤¹ > å­¦ä¹  > ç¼–ç¨‹'
                    },
                    {
                        title: 'æµ‹è¯•ä¹¦ç­¾-æ·±å±‚åµŒå¥—',
                        url: 'https://example.com/deep',
                        folder: 'åŒæ­¥æ”¶è—å¤¹ > ä¸ªäººèµ„æ–™ > ç¤¾äº¤åª’ä½“ > å¾®åš'
                    }
                ];
                
                for (const bookmark of testBookmarks) {
                    log(`ğŸ“š åˆ›å»ºæµ‹è¯•ä¹¦ç­¾: ${bookmark.title} -> ${bookmark.folder}`);
                    
                    const response = await fetch(`${settings.serverUrl || 'http://localhost:3001'}/bookmarks`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${settings.token}`
                        },
                        body: JSON.stringify(bookmark)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        log(`âœ… ä¹¦ç­¾åˆ›å»ºæˆåŠŸ: ${bookmark.title}`);
                        log(`ğŸ“Š æœåŠ¡å™¨å“åº”: ${JSON.stringify(result.bookmark)}`);
                    } else {
                        const error = await response.text();
                        log(`âŒ ä¹¦ç­¾åˆ›å»ºå¤±è´¥: ${bookmark.title} - ${response.status} - ${error}`);
                    }
                    
                    // ç­‰å¾…ä¸€ä¸‹ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                log('ğŸ’¡ è¯·æ£€æŸ¥å…¶ä»–æµè§ˆå™¨æ˜¯å¦æ­£ç¡®åŒæ­¥äº†æ–‡ä»¶å¤¹ç»“æ„');
                log('ğŸ” ç­‰å¾…5ç§’åè‡ªåŠ¨åˆ·æ–°æ–‡ä»¶å¤¹ç»“æ„...');
                
                // åˆ·æ–°æ˜¾ç¤º
                setTimeout(showCurrentStructure, 5000);
                
            } catch (error) {
                log('âŒ æµ‹è¯•æ–‡ä»¶å¤¹åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…ç†æµ‹è¯•æ•°æ®
        async function cleanupTestData() {
            try {
                if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤åŒæ­¥æ”¶è—å¤¹ä¸­çš„æ‰€æœ‰æµ‹è¯•ä¹¦ç­¾å’Œæ–‡ä»¶å¤¹ã€‚')) {
                    return;
                }
                
                log('ğŸ—‘ï¸ æ¸…ç†æµ‹è¯•æ•°æ®...');
                
                const syncFolders = await chrome.bookmarks.search({title: 'åŒæ­¥æ”¶è—å¤¹'});
                if (syncFolders.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"');
                    return;
                }
                
                const children = await chrome.bookmarks.getChildren(syncFolders[0].id);
                let deletedCount = 0;
                
                for (const child of children) {
                    if (child.title.includes('æµ‹è¯•') || 
                        ['ä¸ªäººèµ„æ–™', 'å·¥ä½œ', 'å­¦ä¹ '].includes(child.title)) {
                        try {
                            await chrome.bookmarks.removeTree(child.id);
                            log(`ğŸ—‘ï¸ å·²åˆ é™¤: ${child.title}`);
                            deletedCount++;
                        } catch (error) {
                            log(`âŒ åˆ é™¤å¤±è´¥: ${child.title} - ${error.message}`);
                        }
                    }
                }
                
                log(`âœ… æ¸…ç†å®Œæˆï¼Œåˆ é™¤äº† ${deletedCount} ä¸ªé¡¹ç›®`);
                
                // åˆ·æ–°æ˜¾ç¤º
                setTimeout(showCurrentStructure, 1000);
                
            } catch (error) {
                log('âŒ æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('ğŸ“„ æ—¥å¿—å·²æ¸…ç©º');
        }
    </script>
</body>
</html>