<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•æ–‡ä»¶å¤¹åŒæ­¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ç®€å•æ–‡ä»¶å¤¹åŒæ­¥æµ‹è¯•</h1>
        
        <div id="status" class="status info">
            å‡†å¤‡æµ‹è¯•æ–‡ä»¶å¤¹åŒæ­¥åŠŸèƒ½...
        </div>
        
        <div>
            <button onclick="testSingleBookmark()">æµ‹è¯•å•ä¸ªä¹¦ç­¾åŒæ­¥</button>
            <button onclick="testNestedFolder()">æµ‹è¯•åµŒå¥—æ–‡ä»¶å¤¹</button>
            <button onclick="checkSyncFolder()">æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div id="logContainer" class="log"></div>
    </div>

    <script>
        let logContainer;
        let statusDiv;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            statusDiv = document.getElementById('status');
            log('ğŸ“„ ç®€å•æ–‡ä»¶å¤¹åŒæ­¥æµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            // æ£€æŸ¥æ‰©å±•ç¯å¢ƒ
            if (typeof chrome !== 'undefined' && chrome.bookmarks) {
                log('âœ… Chromeæ‰©å±•ç¯å¢ƒæ£€æµ‹æˆåŠŸ');
                updateStatus('Chromeæ‰©å±•ç¯å¢ƒæ­£å¸¸', 'success');
            } else {
                log('âŒ æœªæ£€æµ‹åˆ°Chromeæ‰©å±•ç¯å¢ƒ');
                updateStatus('è¯·åœ¨Chromeæ‰©å±•ä¸­æ‰“å¼€æ­¤é¡µé¢', 'error');
            }
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(message);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
            }
        }

        // æµ‹è¯•å•ä¸ªä¹¦ç­¾åŒæ­¥
        async function testSingleBookmark() {
            try {
                log('ğŸ§ª å¼€å§‹æµ‹è¯•å•ä¸ªä¹¦ç­¾åŒæ­¥...');
                updateStatus('æ­£åœ¨æµ‹è¯•å•ä¸ªä¹¦ç­¾åŒæ­¥...', 'info');
                
                // è·å–è®¾ç½®
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                    updateStatus('è¯·å…ˆç™»å½•ç³»ç»Ÿ', 'error');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                log('ğŸ”— æœåŠ¡å™¨åœ°å€: ' + serverUrl);
                
                // åˆ›å»ºæµ‹è¯•ä¹¦ç­¾
                const testBookmark = {
                    title: 'æµ‹è¯•ä¹¦ç­¾-' + Date.now(),
                    url: 'https://example.com/test-' + Date.now(),
                    folder: 'åŒæ­¥æ”¶è—å¤¹ > æµ‹è¯•æ–‡ä»¶å¤¹'
                };
                
                log('ğŸ“š åˆ›å»ºä¹¦ç­¾: ' + JSON.stringify(testBookmark));
                
                const response = await fetch(`${serverUrl}/bookmarks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.token}`
                    },
                    body: JSON.stringify(testBookmark)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… ä¹¦ç­¾åˆ›å»ºæˆåŠŸ: ' + JSON.stringify(result));
                    updateStatus('ä¹¦ç­¾åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…åŒæ­¥...', 'success');
                    
                    // ç­‰å¾…5ç§’åæ£€æŸ¥åŒæ­¥ç»“æœ
                    setTimeout(async () => {
                        await checkSyncResult(testBookmark.url);
                    }, 5000);
                    
                } else {
                    const error = await response.text();
                    log('âŒ ä¹¦ç­¾åˆ›å»ºå¤±è´¥: ' + error);
                    updateStatus('ä¹¦ç­¾åˆ›å»ºå¤±è´¥', 'error');
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
                updateStatus('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥åŒæ­¥ç»“æœ
        async function checkSyncResult(url) {
            try {
                log('ğŸ” æ£€æŸ¥åŒæ­¥ç»“æœ...');
                
                // æœç´¢ä¹¦ç­¾
                const bookmarks = await chrome.bookmarks.search({url: url});
                
                if (bookmarks.length > 0) {
                    const bookmark = bookmarks[0];
                    log('âœ… æ‰¾åˆ°åŒæ­¥çš„ä¹¦ç­¾: ' + bookmark.title);
                    
                    // è·å–çˆ¶æ–‡ä»¶å¤¹ä¿¡æ¯
                    const parent = await chrome.bookmarks.get(bookmark.parentId);
                    log('ğŸ“ ä¹¦ç­¾ä½ç½®: ' + parent[0].title);
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„æ–‡ä»¶å¤¹ä¸­
                    if (parent[0].title === 'æµ‹è¯•æ–‡ä»¶å¤¹') {
                        log('âœ… æ–‡ä»¶å¤¹åŒæ­¥æˆåŠŸï¼');
                        updateStatus('æ–‡ä»¶å¤¹åŒæ­¥æˆåŠŸï¼', 'success');
                    } else {
                        log('âš ï¸ ä¹¦ç­¾åŒæ­¥äº†ï¼Œä½†æ–‡ä»¶å¤¹ä½ç½®å¯èƒ½ä¸æ­£ç¡®');
                        updateStatus('ä¹¦ç­¾åŒæ­¥äº†ï¼Œä½†æ–‡ä»¶å¤¹ä½ç½®éœ€è¦æ£€æŸ¥', 'info');
                    }
                    
                } else {
                    log('âŒ æœªæ‰¾åˆ°åŒæ­¥çš„ä¹¦ç­¾');
                    updateStatus('ä¹¦ç­¾æœªåŒæ­¥åˆ°æœ¬åœ°', 'error');
                }
                
            } catch (error) {
                log('âŒ æ£€æŸ¥åŒæ­¥ç»“æœå¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•åµŒå¥—æ–‡ä»¶å¤¹
        async function testNestedFolder() {
            try {
                log('ğŸ§ª å¼€å§‹æµ‹è¯•åµŒå¥—æ–‡ä»¶å¤¹åŒæ­¥...');
                updateStatus('æ­£åœ¨æµ‹è¯•åµŒå¥—æ–‡ä»¶å¤¹åŒæ­¥...', 'info');
                
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•');
                    updateStatus('è¯·å…ˆç™»å½•ç³»ç»Ÿ', 'error');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                
                // åˆ›å»ºæ·±å±‚åµŒå¥—çš„æµ‹è¯•ä¹¦ç­¾
                const testBookmark = {
                    title: 'æ·±å±‚æµ‹è¯•ä¹¦ç­¾-' + Date.now(),
                    url: 'https://example.com/deep-test-' + Date.now(),
                    folder: 'åŒæ­¥æ”¶è—å¤¹ > å·¥ä½œ > é¡¹ç›®A > æ–‡æ¡£ > é‡è¦æ–‡ä»¶'
                };
                
                log('ğŸ“š åˆ›å»ºæ·±å±‚åµŒå¥—ä¹¦ç­¾: ' + JSON.stringify(testBookmark));
                
                const response = await fetch(`${serverUrl}/bookmarks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.token}`
                    },
                    body: JSON.stringify(testBookmark)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… æ·±å±‚åµŒå¥—ä¹¦ç­¾åˆ›å»ºæˆåŠŸ');
                    updateStatus('æ·±å±‚åµŒå¥—ä¹¦ç­¾åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…åŒæ­¥...', 'success');
                    
                    // ç­‰å¾…8ç§’åæ£€æŸ¥åŒæ­¥ç»“æœ
                    setTimeout(async () => {
                        await checkNestedSyncResult(testBookmark.url);
                    }, 8000);
                    
                } else {
                    const error = await response.text();
                    log('âŒ æ·±å±‚åµŒå¥—ä¹¦ç­¾åˆ›å»ºå¤±è´¥: ' + error);
                    updateStatus('æ·±å±‚åµŒå¥—ä¹¦ç­¾åˆ›å»ºå¤±è´¥', 'error');
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•åµŒå¥—æ–‡ä»¶å¤¹å¤±è´¥: ' + error.message);
                updateStatus('æµ‹è¯•åµŒå¥—æ–‡ä»¶å¤¹å¤±è´¥', 'error');
            }
        }

        // æ£€æŸ¥åµŒå¥—åŒæ­¥ç»“æœ
        async function checkNestedSyncResult(url) {
            try {
                log('ğŸ” æ£€æŸ¥åµŒå¥—æ–‡ä»¶å¤¹åŒæ­¥ç»“æœ...');
                
                const bookmarks = await chrome.bookmarks.search({url: url});
                
                if (bookmarks.length > 0) {
                    const bookmark = bookmarks[0];
                    log('âœ… æ‰¾åˆ°æ·±å±‚åµŒå¥—ä¹¦ç­¾: ' + bookmark.title);
                    
                    // è·å–å®Œæ•´è·¯å¾„
                    const path = await getBookmarkPath(bookmark.parentId);
                    log('ğŸ“ å®Œæ•´è·¯å¾„: ' + path);
                    
                    if (path.includes('é‡è¦æ–‡ä»¶')) {
                        log('âœ… æ·±å±‚åµŒå¥—æ–‡ä»¶å¤¹åŒæ­¥æˆåŠŸï¼');
                        updateStatus('æ·±å±‚åµŒå¥—æ–‡ä»¶å¤¹åŒæ­¥æˆåŠŸï¼', 'success');
                    } else {
                        log('âš ï¸ æ·±å±‚åµŒå¥—å¯èƒ½ä¸å®Œæ•´');
                        updateStatus('æ·±å±‚åµŒå¥—å¯èƒ½ä¸å®Œæ•´', 'info');
                    }
                    
                } else {
                    log('âŒ æœªæ‰¾åˆ°æ·±å±‚åµŒå¥—ä¹¦ç­¾');
                    updateStatus('æ·±å±‚åµŒå¥—ä¹¦ç­¾æœªåŒæ­¥', 'error');
                }
                
            } catch (error) {
                log('âŒ æ£€æŸ¥åµŒå¥—åŒæ­¥ç»“æœå¤±è´¥: ' + error.message);
            }
        }

        // è·å–ä¹¦ç­¾å®Œæ•´è·¯å¾„
        async function getBookmarkPath(folderId) {
            try {
                const path = [];
                let currentId = folderId;
                
                while (currentId && currentId !== '0') {
                    const folder = await chrome.bookmarks.get(currentId);
                    if (folder && folder[0]) {
                        path.unshift(folder[0].title);
                        currentId = folder[0].parentId;
                    } else {
                        break;
                    }
                }
                
                return path.join(' > ');
            } catch (error) {
                return 'è·¯å¾„è·å–å¤±è´¥';
            }
        }

        // æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹
        async function checkSyncFolder() {
            try {
                log('ğŸ” æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹çŠ¶æ€...');
                updateStatus('æ­£åœ¨æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹...', 'info');
                
                const syncFolders = await chrome.bookmarks.search({title: 'åŒæ­¥æ”¶è—å¤¹'});
                
                if (syncFolders.length === 0) {
                    log('âŒ æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"');
                    updateStatus('æœªæ‰¾åˆ°åŒæ­¥æ”¶è—å¤¹', 'error');
                    return;
                }
                
                const syncFolder = syncFolders[0];
                log('âœ… æ‰¾åˆ°åŒæ­¥æ”¶è—å¤¹: ' + syncFolder.id);
                
                // è·å–å­æ–‡ä»¶å¤¹
                const children = await chrome.bookmarks.getChildren(syncFolder.id);
                log('ğŸ“‚ å­æ–‡ä»¶å¤¹æ•°é‡: ' + children.length);
                
                for (const child of children) {
                    if (child.url) {
                        log('ğŸ“„ ä¹¦ç­¾: ' + child.title);
                    } else {
                        log('ğŸ“ æ–‡ä»¶å¤¹: ' + child.title);
                        
                        // è·å–å­æ–‡ä»¶å¤¹çš„å†…å®¹
                        const subChildren = await chrome.bookmarks.getChildren(child.id);
                        for (const subChild of subChildren) {
                            if (subChild.url) {
                                log('  ğŸ“„ ' + subChild.title);
                            } else {
                                log('  ğŸ“ ' + subChild.title);
                            }
                        }
                    }
                }
                
                updateStatus('åŒæ­¥æ”¶è—å¤¹æ£€æŸ¥å®Œæˆ', 'success');
                
            } catch (error) {
                log('âŒ æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹å¤±è´¥: ' + error.message);
                updateStatus('æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('ğŸ“„ æ—¥å¿—å·²æ¸…ç©º');
        }
    </script>
</body>
</html>