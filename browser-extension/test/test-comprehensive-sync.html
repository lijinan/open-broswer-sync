<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»¼åˆåŒæ­¥åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007cba;
        }
        .issue-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .success-section {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button.warning {
            background: #ffc107;
            color: #000;
        }
        button.danger {
            background: #dc3545;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #28a745; color: white; }
        .status.warning { background: #ffc107; color: #000; }
        .status.error { background: #dc3545; color: white; }
        .status.info { background: #17a2b8; color: white; }
    </style>
</head>
<body>
    <h1>ğŸ”„ ç»¼åˆåŒæ­¥åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="issue-section">
        <h2>ğŸ› å½“å‰é—®é¢˜</h2>
        <ul>
            <li><span class="status warning">ä¿®å¤ä¸­</span> æ”¶è—æ—¶é€šçŸ¥åˆ›å»ºå¤±è´¥</li>
            <li><span class="status warning">ä¿®å¤ä¸­</span> åˆ é™¤æ—¶æ²¡æœ‰é€šçŸ¥æç¤º</li>
            <li><span class="status success">å·²æ·»åŠ </span> é‡å¤ä¹¦ç­¾æ£€æµ‹åŠŸèƒ½</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ ä¿®å¤å†…å®¹</h2>
        <ul>
            <li><strong>é€šçŸ¥ä¿®å¤</strong>ï¼šä½¿ç”¨ChromeåŸç”ŸAPIï¼Œé¿å…polyfillé—®é¢˜</li>
            <li><strong>é‡å¤æ£€æµ‹</strong>ï¼šä¿å­˜å‰æ£€æŸ¥URLæ˜¯å¦å·²å­˜åœ¨</li>
            <li><strong>å¢å¼ºæ—¥å¿—</strong>ï¼šæ·»åŠ æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æµ‹è¯•åŠŸèƒ½</h2>
        
        <h3>1. é€šçŸ¥æµ‹è¯•</h3>
        <button onclick="testNotification()">æµ‹è¯•é€šçŸ¥åŠŸèƒ½</button>
        <button onclick="testNotificationTypes()">æµ‹è¯•ä¸åŒç±»å‹é€šçŸ¥</button>
        
        <h3>2. ä¹¦ç­¾åˆ›å»ºæµ‹è¯•</h3>
        <button onclick="createTestBookmark()">åˆ›å»ºæµ‹è¯•ä¹¦ç­¾</button>
        <button onclick="createDuplicateBookmark()">åˆ›å»ºé‡å¤ä¹¦ç­¾ï¼ˆæµ‹è¯•æ£€æµ‹ï¼‰</button>
        
        <h3>3. ä¹¦ç­¾åˆ é™¤æµ‹è¯•</h3>
        <button onclick="deleteLastBookmark()">åˆ é™¤æœ€åçš„æµ‹è¯•ä¹¦ç­¾</button>
        <button onclick="deleteAllTestBookmarks()">æ¸…ç†æ‰€æœ‰æµ‹è¯•ä¹¦ç­¾</button>
        
        <h3>4. ç³»ç»Ÿæ£€æŸ¥</h3>
        <button onclick="checkExtensionStatus()">æ£€æŸ¥æ‰©å±•çŠ¶æ€</button>
        <button onclick="checkSyncFolder()">æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹</button>
        <button onclick="checkServerConnection()">æ£€æŸ¥æœåŠ¡å™¨è¿æ¥</button>
        
        <h3>5. æ—¥å¿—æ§åˆ¶</h3>
        <button onclick="enableDebugMode()">å¼€å¯è°ƒè¯•æ¨¡å¼</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <div id="log" class="log">ç­‰å¾…æµ‹è¯•...\n</div>
    </div>

    <script>
        let testBookmarks = [];
        let testCounter = 0;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        // 1. é€šçŸ¥æµ‹è¯•
        async function testNotification() {
            log('ğŸ”” æµ‹è¯•åŸºæœ¬é€šçŸ¥åŠŸèƒ½...');
            try {
                const response = await chrome.runtime.sendMessage({
                    type: 'TEST_NOTIFICATION',
                    message: `æµ‹è¯•é€šçŸ¥ - ${new Date().toLocaleTimeString()}`
                });
                log('é€šçŸ¥æµ‹è¯•æ¶ˆæ¯å·²å‘é€', 'success');
            } catch (error) {
                log(`é€šçŸ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testNotificationTypes() {
            log('ğŸ”” æµ‹è¯•ä¸åŒç±»å‹çš„é€šçŸ¥...');
            const messages = [
                { msg: 'æˆåŠŸé€šçŸ¥æµ‹è¯•', type: 'success' },
                { msg: 'è­¦å‘Šé€šçŸ¥æµ‹è¯•', type: 'warning' },
                { msg: 'é”™è¯¯é€šçŸ¥æµ‹è¯•', type: 'error' },
                { msg: 'ä¿¡æ¯é€šçŸ¥æµ‹è¯•', type: 'info' }
            ];

            for (let i = 0; i < messages.length; i++) {
                setTimeout(async () => {
                    try {
                        await chrome.runtime.sendMessage({
                            type: 'TEST_NOTIFICATION',
                            message: messages[i].msg
                        });
                        log(`${messages[i].type}é€šçŸ¥å·²å‘é€`, 'success');
                    } catch (error) {
                        log(`${messages[i].type}é€šçŸ¥å¤±è´¥: ${error.message}`, 'error');
                    }
                }, i * 1000);
            }
        }

        // 2. ä¹¦ç­¾åˆ›å»ºæµ‹è¯•
        async function createTestBookmark() {
            try {
                log('ğŸ“š å¼€å§‹åˆ›å»ºæµ‹è¯•ä¹¦ç­¾...');
                
                const syncFolders = await new Promise((resolve) => {
                    chrome.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' }, resolve);
                });
                
                if (syncFolders.length === 0) {
                    log('æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"ï¼Œè¯·å…ˆåˆ›å»º', 'error');
                    return;
                }
                
                testCounter++;
                const testBookmark = await new Promise((resolve) => {
                    chrome.bookmarks.create({
                        title: `æµ‹è¯•ä¹¦ç­¾${testCounter} - ${Date.now()}`,
                        url: `https://test-bookmark-${testCounter}.example.com/${Date.now()}`,
                        parentId: syncFolders[0].id
                    }, resolve);
                });
                
                testBookmarks.push(testBookmark);
                log(`æµ‹è¯•ä¹¦ç­¾å·²åˆ›å»º: ${testBookmark.title}`, 'success');
                log(`ä¹¦ç­¾ID: ${testBookmark.id}`);
                
            } catch (error) {
                log(`åˆ›å»ºæµ‹è¯•ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createDuplicateBookmark() {
            try {
                if (testBookmarks.length === 0) {
                    log('è¯·å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•ä¹¦ç­¾', 'warning');
                    return;
                }

                log('ğŸ“š åˆ›å»ºé‡å¤ä¹¦ç­¾æµ‹è¯•é‡å¤æ£€æµ‹...');
                
                const syncFolders = await new Promise((resolve) => {
                    chrome.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' }, resolve);
                });
                
                const lastBookmark = testBookmarks[testBookmarks.length - 1];
                
                const duplicateBookmark = await new Promise((resolve) => {
                    chrome.bookmarks.create({
                        title: `é‡å¤ä¹¦ç­¾ - ${lastBookmark.title}`,
                        url: lastBookmark.url, // ä½¿ç”¨ç›¸åŒçš„URL
                        parentId: syncFolders[0].id
                    }, resolve);
                });
                
                log(`é‡å¤ä¹¦ç­¾å·²åˆ›å»º: ${duplicateBookmark.title}`, 'success');
                log('ç­‰å¾…é‡å¤æ£€æµ‹ç»“æœ...');
                
            } catch (error) {
                log(`åˆ›å»ºé‡å¤ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. ä¹¦ç­¾åˆ é™¤æµ‹è¯•
        async function deleteLastBookmark() {
            try {
                if (testBookmarks.length === 0) {
                    log('æ²¡æœ‰å¯åˆ é™¤çš„æµ‹è¯•ä¹¦ç­¾', 'warning');
                    return;
                }

                const lastBookmark = testBookmarks.pop();
                log(`ğŸ—‘ï¸ åˆ é™¤æµ‹è¯•ä¹¦ç­¾: ${lastBookmark.title}`);
                
                await new Promise((resolve) => {
                    chrome.bookmarks.remove(lastBookmark.id, resolve);
                });
                
                log(`æµ‹è¯•ä¹¦ç­¾å·²åˆ é™¤: ${lastBookmark.title}`, 'success');
                log('ç­‰å¾…åˆ é™¤åŒæ­¥é€šçŸ¥...');
                
            } catch (error) {
                log(`åˆ é™¤æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteAllTestBookmarks() {
            try {
                log('ğŸ—‘ï¸ æ¸…ç†æ‰€æœ‰æµ‹è¯•ä¹¦ç­¾...');
                
                while (testBookmarks.length > 0) {
                    const bookmark = testBookmarks.pop();
                    await new Promise((resolve) => {
                        chrome.bookmarks.remove(bookmark.id, resolve);
                    });
                    log(`å·²åˆ é™¤: ${bookmark.title}`);
                    // å»¶è¿Ÿä¸€ä¸‹ï¼Œé¿å…è¿‡å¿«åˆ é™¤
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                log('æ‰€æœ‰æµ‹è¯•ä¹¦ç­¾å·²æ¸…ç†å®Œæˆ', 'success');
                
            } catch (error) {
                log(`æ¸…ç†æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 4. ç³»ç»Ÿæ£€æŸ¥
        async function checkExtensionStatus() {
            log('ğŸ” æ£€æŸ¥æ‰©å±•çŠ¶æ€...');
            
            try {
                const settings = await chrome.storage.sync.get();
                log(`ç™»å½•çŠ¶æ€: ${settings.token ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`);
                log(`æœåŠ¡å™¨åœ°å€: ${settings.serverUrl || 'æœªé…ç½®'}`);
                log(`è°ƒè¯•æ¨¡å¼: ${settings.debugMode ? 'å·²å¼€å¯' : 'æœªå¼€å¯'}`);
                
                if (settings.token) {
                    log('æ‰©å±•çŠ¶æ€æ­£å¸¸', 'success');
                } else {
                    log('è¯·å…ˆç™»å½•æ‰©å±•', 'warning');
                }
                
            } catch (error) {
                log(`æ£€æŸ¥æ‰©å±•çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkSyncFolder() {
            log('ğŸ“ æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹...');
            
            try {
                const syncFolders = await new Promise((resolve) => {
                    chrome.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' }, resolve);
                });
                
                if (syncFolders.length > 0) {
                    log(`æ‰¾åˆ°åŒæ­¥æ”¶è—å¤¹: ${syncFolders.length}ä¸ª`, 'success');
                    syncFolders.forEach((folder, index) => {
                        log(`  ${index + 1}. ID: ${folder.id}, çˆ¶çº§: ${folder.parentId}`);
                    });
                } else {
                    log('æœªæ‰¾åˆ°åŒæ­¥æ”¶è—å¤¹ï¼Œè¯·å…ˆåˆ›å»º', 'warning');
                }
                
            } catch (error) {
                log(`æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkServerConnection() {
            log('ğŸŒ æ£€æŸ¥æœåŠ¡å™¨è¿æ¥...');
            
            try {
                const settings = await chrome.storage.sync.get(['serverUrl', 'token']);
                
                if (!settings.serverUrl) {
                    log('æœåŠ¡å™¨åœ°å€æœªé…ç½®', 'error');
                    return;
                }
                
                log(`æµ‹è¯•æœåŠ¡å™¨: ${settings.serverUrl}`);
                
                // æµ‹è¯•å¥åº·æ£€æŸ¥
                const healthResponse = await fetch(`${settings.serverUrl}/health`);
                if (healthResponse.ok) {
                    log('æœåŠ¡å™¨å¥åº·æ£€æŸ¥é€šè¿‡', 'success');
                } else {
                    log('æœåŠ¡å™¨å¥åº·æ£€æŸ¥å¤±è´¥', 'error');
                }
                
                // æµ‹è¯•è®¤è¯
                if (settings.token) {
                    const authResponse = await fetch(`${settings.serverUrl}/auth/verify`, {
                        headers: { 'Authorization': `Bearer ${settings.token}` }
                    });
                    
                    if (authResponse.ok) {
                        const userData = await authResponse.json();
                        log(`ç”¨æˆ·è®¤è¯é€šè¿‡: ${userData.user.name}`, 'success');
                    } else {
                        log('ç”¨æˆ·è®¤è¯å¤±è´¥', 'error');
                    }
                }
                
            } catch (error) {
                log(`æœåŠ¡å™¨è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 5. è°ƒè¯•æ§åˆ¶
        async function enableDebugMode() {
            try {
                await chrome.storage.sync.set({ debugMode: true });
                log('è°ƒè¯•æ¨¡å¼å·²å¼€å¯', 'success');
            } catch (error) {
                log(`å¼€å¯è°ƒè¯•æ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç›‘å¬æ¥è‡ªåå°è„šæœ¬çš„æ¶ˆæ¯
        chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
            if (request.type === 'TEST_LOG') {
                log(request.message, request.logType || 'info');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        log('ğŸ“‹ ç»¼åˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ğŸ’¡ å»ºè®®æµ‹è¯•é¡ºåº:');
        log('   1. æ£€æŸ¥æ‰©å±•çŠ¶æ€');
        log('   2. æ£€æŸ¥åŒæ­¥æ”¶è—å¤¹');
        log('   3. å¼€å¯è°ƒè¯•æ¨¡å¼');
        log('   4. æµ‹è¯•é€šçŸ¥åŠŸèƒ½');
        log('   5. åˆ›å»ºå’Œåˆ é™¤æµ‹è¯•ä¹¦ç­¾');
    </script>
</body>
</html>