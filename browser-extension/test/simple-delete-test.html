<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单删除同步测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .step {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .code {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .debug-button {
            background: #6c757d;
        }
        .test-button {
            background: #28a745;
        }
        .danger-button {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <h1>🔍 简单删除同步测试</h1>
    
    <div class="step warning">
        <h3>⚠️ 问题描述</h3>
        <p>浏览器删除"同步收藏夹"中的书签时，没有同步删除服务器上的书签。</p>
    </div>

    <div class="step">
        <h3>🔧 快速诊断</h3>
        <p>点击下面的按钮进行快速诊断：</p>
        <button onclick="openBackgroundPage()">打开后台页面</button>
        <button onclick="enableDebugMode()" class="debug-button">开启调试模式</button>
        <button onclick="checkExtensionStatus()" class="test-button">检查扩展状态</button>
    </div>

    <div class="step">
        <h3>📋 手动检查步骤</h3>
        
        <h4>步骤1: 检查后台脚本</h4>
        <ol>
            <li>右键点击扩展图标 → "检查弹出内容"</li>
            <li>在开发者工具中点击"Console"标签</li>
            <li>输入以下代码检查后台脚本：</li>
        </ol>
        <div class="code">
chrome.runtime.getBackgroundPage((backgroundPage) => {
  console.log('后台页面:', backgroundPage);
  console.log('ExtensionBackground实例:', backgroundPage.ExtensionBackground);
});
        </div>

        <h4>步骤2: 开启调试模式</h4>
        <div class="code">
chrome.storage.sync.set({debugMode: true}, () => {
  console.log('调试模式已开启');
});
        </div>

        <h4>步骤3: 检查事件监听</h4>
        <div class="code">
// 添加临时删除监听器
chrome.bookmarks.onRemoved.addListener((id, removeInfo) => {
  console.log('🔔 书签删除事件:', {id, removeInfo});
});
        </div>

        <h4>步骤4: 测试删除</h4>
        <ol>
            <li>在"同步收藏夹"中创建一个测试书签</li>
            <li>删除这个测试书签</li>
            <li>观察控制台输出</li>
        </ol>
    </div>

    <div class="step">
        <h3>🐛 常见问题排查</h3>
        
        <h4>问题1: 事件监听器未触发</h4>
        <ul>
            <li>检查扩展是否正确加载</li>
            <li>检查后台脚本是否运行</li>
            <li>重新加载扩展</li>
        </ul>

        <h4>问题2: 文件夹检测失败</h4>
        <ul>
            <li>确认文件夹名称是"同步收藏夹"</li>
            <li>检查文件夹层级结构</li>
            <li>查看调试日志</li>
        </ul>

        <h4>问题3: 服务器API调用失败</h4>
        <ul>
            <li>检查网络连接</li>
            <li>验证登录状态</li>
            <li>测试API端点</li>
        </ul>
    </div>

    <div class="step">
        <h3>🧪 自动化测试</h3>
        <p>运行自动化测试脚本：</p>
        <button onclick="runAutomatedTest()" class="test-button">运行自动测试</button>
        <button onclick="createTestBookmark()" class="test-button">创建测试书签</button>
        <button onclick="deleteAllTestBookmarks()" class="danger-button">清理测试书签</button>
    </div>

    <div class="step success">
        <h3>✅ 预期行为</h3>
        <p>正常情况下，删除"同步收藏夹"中的书签时应该：</p>
        <ol>
            <li>控制台显示："书签删除事件: {id: ..., removeInfo: ...}"</li>
            <li>控制台显示："检测到同步收藏夹中的书签被删除: [书签标题]"</li>
            <li>控制台显示："✅ 书签删除已同步到服务器: [书签标题]"</li>
            <li>显示通知："书签'[标题]'的删除已同步到服务器"</li>
            <li>服务器上对应书签被删除</li>
        </ol>
    </div>

    <div class="step error">
        <h3>❌ 如果仍然不工作</h3>
        <p>请提供以下信息：</p>
        <ul>
            <li>控制台的完整日志</li>
            <li>扩展是否正确加载</li>
            <li>是否已登录扩展</li>
            <li>服务器是否正常运行</li>
            <li>"同步收藏夹"文件夹是否存在</li>
        </ul>
    </div>

    <script>
        function openBackgroundPage() {
            chrome.runtime.getBackgroundPage((backgroundPage) => {
                if (backgroundPage) {
                    console.log('后台页面已打开，请查看控制台');
                    // 在后台页面执行调试代码
                    backgroundPage.console.log('🔍 从测试页面调用后台脚本');
                } else {
                    console.error('无法访问后台页面');
                }
            });
        }

        function enableDebugMode() {
            chrome.storage.sync.set({debugMode: true}, () => {
                console.log('✅ 调试模式已开启');
                alert('调试模式已开启，请查看控制台日志');
            });
        }

        function checkExtensionStatus() {
            chrome.storage.sync.get(['token', 'serverUrl', 'debugMode'], (settings) => {
                console.log('扩展设置:', settings);
                
                let status = '扩展状态检查:\n';
                status += `- 登录状态: ${settings.token ? '已登录' : '未登录'}\n`;
                status += `- 服务器地址: ${settings.serverUrl || '未设置'}\n`;
                status += `- 调试模式: ${settings.debugMode ? '已开启' : '未开启'}\n`;
                
                alert(status);
            });
        }

        async function runAutomatedTest() {
            console.log('🚀 开始自动化测试...');
            
            // 检查书签API
            if (!chrome.bookmarks) {
                alert('❌ 书签API不可用');
                return;
            }
            
            // 添加临时监听器
            const testListener = (id, removeInfo) => {
                console.log('🔔 测试监听器捕获删除事件:', {id, removeInfo});
            };
            
            chrome.bookmarks.onRemoved.addListener(testListener);
            console.log('✅ 测试监听器已添加');
            
            alert('自动化测试已开始，请在"同步收藏夹"中删除一个书签，然后查看控制台日志');
            
            // 10秒后移除监听器
            setTimeout(() => {
                chrome.bookmarks.onRemoved.removeListener(testListener);
                console.log('🗑️ 测试监听器已移除');
            }, 10000);
        }

        async function createTestBookmark() {
            try {
                // 查找同步收藏夹
                chrome.bookmarks.search({title: '同步收藏夹'}, (results) => {
                    if (results.length === 0) {
                        alert('❌ 未找到"同步收藏夹"文件夹，请先创建');
                        return;
                    }
                    
                    const syncFolder = results[0];
                    
                    // 创建测试书签
                    chrome.bookmarks.create({
                        title: '测试书签 - ' + new Date().toLocaleTimeString(),
                        url: 'https://example.com/test-' + Date.now(),
                        parentId: syncFolder.id
                    }, (bookmark) => {
                        console.log('✅ 测试书签已创建:', bookmark);
                        alert(`测试书签已创建: ${bookmark.title}`);
                    });
                });
            } catch (error) {
                console.error('创建测试书签失败:', error);
                alert('❌ 创建测试书签失败: ' + error.message);
            }
        }

        async function deleteAllTestBookmarks() {
            try {
                chrome.bookmarks.search({title: '测试书签'}, (results) => {
                    if (results.length === 0) {
                        alert('没有找到测试书签');
                        return;
                    }
                    
                    let deleted = 0;
                    results.forEach((bookmark) => {
                        if (bookmark.title.startsWith('测试书签')) {
                            chrome.bookmarks.remove(bookmark.id, () => {
                                deleted++;
                                console.log('🗑️ 已删除测试书签:', bookmark.title);
                                
                                if (deleted === results.length) {
                                    alert(`已清理 ${deleted} 个测试书签`);
                                }
                            });
                        }
                    });
                });
            } catch (error) {
                console.error('清理测试书签失败:', error);
                alert('❌ 清理测试书签失败: ' + error.message);
            }
        }

        // 页面加载时自动检查
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📋 删除同步测试页面已加载');
            console.log('💡 请按照步骤进行测试');
        });
    </script>
</body>
</html>