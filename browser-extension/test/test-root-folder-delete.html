<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¹ç›®å½•ä¹¦ç­¾åˆ é™¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .issue-section {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 10px 0;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        button.danger {
            background: #dc3545;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ æ ¹ç›®å½•ä¹¦ç­¾åˆ é™¤æµ‹è¯•</h1>
    
    <div class="issue-section">
        <h2>ğŸ› é—®é¢˜æè¿°</h2>
        <p>åˆ é™¤"åŒæ­¥æ”¶è—å¤¹"æ ¹ç›®å½•ä¸‹çš„ä¹¦ç­¾æ—¶ï¼ŒparentIdä¸ºundefinedï¼Œå¯¼è‡´æ–‡ä»¶å¤¹æ£€æŸ¥å¤±è´¥ã€‚</p>
        <p><strong>ä¿®å¤æ–¹æ¡ˆï¼š</strong></p>
        <ul>
            <li>ä½¿ç”¨removeInfo.parentIdè¿›è¡Œæ£€æŸ¥</li>
            <li>æ·»åŠ æ–°çš„checkParentIsSyncFolderæ–¹æ³•</li>
            <li>åŒé‡æ£€æŸ¥ç¡®ä¿å‡†ç¡®æ€§</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æµ‹è¯•æ­¥éª¤</h2>
        <ol>
            <li>åœ¨"åŒæ­¥æ”¶è—å¤¹"æ ¹ç›®å½•åˆ›å»ºæµ‹è¯•ä¹¦ç­¾</li>
            <li>åˆ é™¤è¿™ä¸ªä¹¦ç­¾</li>
            <li>è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—</li>
            <li>ç¡®è®¤åˆ é™¤åŒæ­¥æ­£å¸¸å·¥ä½œ</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ æµ‹è¯•æ“ä½œ</h2>
        <button onclick="createRootBookmark()">åœ¨æ ¹ç›®å½•åˆ›å»ºæµ‹è¯•ä¹¦ç­¾</button>
        <button onclick="createSubfolderBookmark()">åœ¨å­æ–‡ä»¶å¤¹åˆ›å»ºæµ‹è¯•ä¹¦ç­¾</button>
        <button onclick="deleteLastBookmark()" class="danger">åˆ é™¤æœ€åçš„æµ‹è¯•ä¹¦ç­¾</button>
        <button onclick="listTestBookmarks()">åˆ—å‡ºæµ‹è¯•ä¹¦ç­¾</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <div id="log" class="log">ç­‰å¾…æµ‹è¯•...\n</div>
    </div>

    <script>
        let testBookmarks = [];

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[é¡µé¢] ${prefix} ${message}`);
        }

        function clearLog() {
            document.getElementById('log').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        async function createRootBookmark() {
            try {
                log('ğŸ“š åœ¨åŒæ­¥æ”¶è—å¤¹æ ¹ç›®å½•åˆ›å»ºæµ‹è¯•ä¹¦ç­¾...');
                
                const syncFolders = await new Promise((resolve) => {
                    chrome.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' }, resolve);
                });
                
                if (syncFolders.length === 0) {
                    log('æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"ï¼Œè¯·å…ˆåˆ›å»º', 'error');
                    return;
                }
                
                const syncFolder = syncFolders[0];
                log(`ä½¿ç”¨åŒæ­¥æ”¶è—å¤¹: ${syncFolder.id}`);
                
                const testBookmark = await new Promise((resolve) => {
                    chrome.bookmarks.create({
                        title: `æ ¹ç›®å½•æµ‹è¯•ä¹¦ç­¾ - ${Date.now()}`,
                        url: `https://root-test.example.com/${Date.now()}`,
                        parentId: syncFolder.id // ç›´æ¥åœ¨æ ¹ç›®å½•ä¸‹
                    }, resolve);
                });
                
                testBookmarks.push(testBookmark);
                log(`æ ¹ç›®å½•æµ‹è¯•ä¹¦ç­¾å·²åˆ›å»º: ${testBookmark.title}`, 'success');
                log(`ä¹¦ç­¾ID: ${testBookmark.id}, çˆ¶çº§ID: ${testBookmark.parentId}`);
                
            } catch (error) {
                log(`åˆ›å»ºæ ¹ç›®å½•æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function createSubfolderBookmark() {
            try {
                log('ğŸ“š åœ¨åŒæ­¥æ”¶è—å¤¹å­æ–‡ä»¶å¤¹åˆ›å»ºæµ‹è¯•ä¹¦ç­¾...');
                
                const syncFolders = await new Promise((resolve) => {
                    chrome.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' }, resolve);
                });
                
                if (syncFolders.length === 0) {
                    log('æœªæ‰¾åˆ°"åŒæ­¥æ”¶è—å¤¹"ï¼Œè¯·å…ˆåˆ›å»º', 'error');
                    return;
                }
                
                const syncFolder = syncFolders[0];
                
                // åˆ›å»ºæˆ–æŸ¥æ‰¾æµ‹è¯•å­æ–‡ä»¶å¤¹
                let testSubfolder;
                const existingSubfolders = await new Promise((resolve) => {
                    chrome.bookmarks.getChildren(syncFolder.id, resolve);
                });
                
                const testFolder = existingSubfolders.find(child => child.title === 'æµ‹è¯•å­æ–‡ä»¶å¤¹');
                if (testFolder) {
                    testSubfolder = testFolder;
                    log(`ä½¿ç”¨ç°æœ‰æµ‹è¯•å­æ–‡ä»¶å¤¹: ${testSubfolder.id}`);
                } else {
                    testSubfolder = await new Promise((resolve) => {
                        chrome.bookmarks.create({
                            title: 'æµ‹è¯•å­æ–‡ä»¶å¤¹',
                            parentId: syncFolder.id
                        }, resolve);
                    });
                    log(`åˆ›å»ºæµ‹è¯•å­æ–‡ä»¶å¤¹: ${testSubfolder.id}`);
                }
                
                const testBookmark = await new Promise((resolve) => {
                    chrome.bookmarks.create({
                        title: `å­æ–‡ä»¶å¤¹æµ‹è¯•ä¹¦ç­¾ - ${Date.now()}`,
                        url: `https://subfolder-test.example.com/${Date.now()}`,
                        parentId: testSubfolder.id
                    }, resolve);
                });
                
                testBookmarks.push(testBookmark);
                log(`å­æ–‡ä»¶å¤¹æµ‹è¯•ä¹¦ç­¾å·²åˆ›å»º: ${testBookmark.title}`, 'success');
                log(`ä¹¦ç­¾ID: ${testBookmark.id}, çˆ¶çº§ID: ${testBookmark.parentId}`);
                
            } catch (error) {
                log(`åˆ›å»ºå­æ–‡ä»¶å¤¹æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteLastBookmark() {
            try {
                if (testBookmarks.length === 0) {
                    log('æ²¡æœ‰å¯åˆ é™¤çš„æµ‹è¯•ä¹¦ç­¾', 'warning');
                    return;
                }

                const bookmarkToDelete = testBookmarks.pop();
                log(`ğŸ—‘ï¸ åˆ é™¤æµ‹è¯•ä¹¦ç­¾: ${bookmarkToDelete.title}`);
                log(`ä¹¦ç­¾ä¿¡æ¯: ID=${bookmarkToDelete.id}, çˆ¶çº§=${bookmarkToDelete.parentId}`);
                
                await new Promise((resolve) => {
                    chrome.bookmarks.remove(bookmarkToDelete.id, resolve);
                });
                
                log(`æµ‹è¯•ä¹¦ç­¾å·²åˆ é™¤: ${bookmarkToDelete.title}`, 'success');
                log('â³ ç­‰å¾…åˆ é™¤åŒæ­¥æ—¥å¿—...');
                log('ğŸ“‹ è¯·æŸ¥çœ‹æ§åˆ¶å°çš„è¯¦ç»†åŒæ­¥è¿‡ç¨‹');
                
            } catch (error) {
                log(`åˆ é™¤æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function listTestBookmarks() {
            log('ğŸ“‹ å½“å‰æµ‹è¯•ä¹¦ç­¾åˆ—è¡¨:');
            if (testBookmarks.length === 0) {
                log('  (æ— æµ‹è¯•ä¹¦ç­¾)');
            } else {
                testBookmarks.forEach((bookmark, index) => {
                    log(`  ${index + 1}. ${bookmark.title} (ID: ${bookmark.id})`);
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        log('ğŸ“‹ æ ¹ç›®å½•ä¹¦ç­¾åˆ é™¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ğŸ’¡ å»ºè®®æµ‹è¯•é¡ºåº:');
        log('   1. åˆ›å»ºæ ¹ç›®å½•æµ‹è¯•ä¹¦ç­¾');
        log('   2. åˆ›å»ºå­æ–‡ä»¶å¤¹æµ‹è¯•ä¹¦ç­¾');
        log('   3. åˆ†åˆ«åˆ é™¤å¹¶è§‚å¯Ÿæ—¥å¿—');
        log('   4. ç¡®è®¤ä¸¤ç§æƒ…å†µéƒ½èƒ½æ­£ç¡®åŒæ­¥');
    </script>
</body>
</html>