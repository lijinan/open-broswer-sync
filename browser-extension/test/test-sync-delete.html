<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>同步删除功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .step-list {
            counter-reset: step-counter;
        }
        .step-list li {
            counter-increment: step-counter;
            margin: 10px 0;
            padding-left: 30px;
            position: relative;
        }
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #dc3545;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .code-block {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            border-left: 4px solid #dc3545;
        }
        .flow-diagram {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>🗑️ 同步删除功能测试指南</h1>
    
    <div class="test-section success">
        <h2>✅ 功能概述</h2>
        <p>同步删除功能确保当你在浏览器中删除"同步收藏夹"中的书签时，服务器上的对应书签也会被自动删除，保持数据一致性。</p>
        
        <h3>🔄 工作原理</h3>
        <div class="flow-diagram">
            <strong>删除流程：</strong><br>
            用户删除书签 → 检测是否来自同步收藏夹 → 检查登录状态 → 按URL搜索服务器书签 → 删除服务器书签 → 显示通知
        </div>
    </div>

    <div class="test-section info">
        <h2>🧪 测试步骤</h2>
        
        <h3>准备工作</h3>
        <ol class="step-list">
            <li>确保后端服务器运行在 http://localhost:3001</li>
            <li>在扩展中登录你的账号</li>
            <li>确保"同步收藏夹"中有一些测试书签</li>
            <li>打开浏览器开发者工具查看控制台</li>
        </ol>

        <h3>测试1：基础删除同步</h3>
        <ol class="step-list">
            <li>在浏览器书签栏中找到"同步收藏夹"文件夹</li>
            <li>右键点击其中一个书签</li>
            <li>选择"删除"</li>
            <li>观察是否出现"书签的删除已同步到服务器"通知</li>
            <li>检查服务器上对应书签是否被删除</li>
        </ol>

        <h3>测试2：多级文件夹删除同步</h3>
        <ol class="step-list">
            <li>在"同步收藏夹 > 工作 > 开发工具"中删除一个书签</li>
            <li>验证服务器上对应的书签被删除</li>
            <li>确认其他文件夹中的书签不受影响</li>
        </ol>

        <h3>测试3：批量删除同步</h3>
        <ol class="step-list">
            <li>选择"同步收藏夹"中的多个书签</li>
            <li>按Delete键或右键删除</li>
            <li>观察每个书签的删除通知</li>
            <li>验证服务器上所有对应书签都被删除</li>
        </ol>

        <h3>测试4：文件夹删除同步</h3>
        <ol class="step-list">
            <li>删除"同步收藏夹"下的一个子文件夹</li>
            <li>观察文件夹内所有书签的删除通知</li>
            <li>验证服务器上对应的所有书签都被删除</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>🔍 调试信息</h2>
        
        <h3>控制台日志</h3>
        <p>删除同步时，控制台应该显示：</p>
        <div class="code-block">
书签删除事件: {id: "123", removeInfo: {...}}
检测到同步收藏夹中的书签被删除: Google
✅ 书签删除已同步到服务器: Google
        </div>

        <h3>API调用流程</h3>
        <div class="code-block">
1. GET /bookmarks/search?url=https://www.google.com
   - 检查服务器上是否存在该书签
   
2. DELETE /bookmarks/:id
   - 删除服务器上的书签
   
3. 显示成功通知
        </div>

        <h3>错误处理</h3>
        <p>如果删除失败，会显示错误信息：</p>
        <div class="code-block">
书签删除同步失败: Network error
        </div>
    </div>

    <div class="test-section warning">
        <h2>⚠️ 注意事项</h2>
        <ul>
            <li><strong>登录要求</strong>：必须在扩展中登录才能同步删除</li>
            <li><strong>文件夹限制</strong>：只有"同步收藏夹"中的书签删除才会同步</li>
            <li><strong>网络连接</strong>：需要能够访问后端服务器</li>
            <li><strong>URL匹配</strong>：通过URL精确匹配服务器上的书签</li>
            <li><strong>不可撤销</strong>：删除操作不可撤销，请谨慎操作</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🛠️ 故障排除</h2>
        
        <h3>常见问题</h3>
        
        <h4>❌ 删除没有同步</h4>
        <ul>
            <li>检查是否已登录扩展</li>
            <li>确认删除的书签在"同步收藏夹"中</li>
            <li>检查网络连接</li>
            <li>查看控制台错误信息</li>
        </ul>

        <h4>❌ 找不到服务器书签</h4>
        <ul>
            <li>URL可能不完全匹配</li>
            <li>书签可能已经被删除</li>
            <li>检查搜索API是否正常</li>
        </ul>

        <h4>❌ 删除API失败</h4>
        <ul>
            <li>检查token是否有效</li>
            <li>确认书签ID正确</li>
            <li>检查服务器API状态</li>
        </ul>

        <h4>❌ 权限错误</h4>
        <ul>
            <li>确认用户有删除权限</li>
            <li>检查书签是否属于当前用户</li>
            <li>重新登录扩展</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🔧 技术实现</h2>
        
        <h3>事件监听</h3>
        <div class="code-block">
chrome.bookmarks.onRemoved.addListener((id, removeInfo) => {
  this.onBookmarkRemoved(id, removeInfo)
})
        </div>

        <h3>文件夹检测</h3>
        <div class="code-block">
async checkBookmarkInSyncFolderByNode(node) {
  // 通过removeInfo.node检查是否在同步文件夹中
  let parentId = node.parentId
  while (parentId) {
    const parentNode = await chrome.bookmarks.get(parentId)
    if (parentNode.title === '同步收藏夹') {
      return true
    }
    parentId = parentNode.parentId
  }
  return false
}
        </div>

        <h3>服务器删除</h3>
        <div class="code-block">
async deleteBookmarkFromServer(url) {
  // 1. 按URL搜索书签
  const serverBookmark = await this.checkBookmarkExistsOnServer(url)
  
  // 2. 删除找到的书签
  const response = await fetch(`/bookmarks/${serverBookmark.id}`, {
    method: 'DELETE',
    headers: { 'Authorization': `Bearer ${token}` }
  })
  
  return response.ok
}
        </div>
    </div>

    <div class="test-section success">
        <h2>🎯 预期结果</h2>
        <ul>
            <li>✅ 删除"同步收藏夹"中的书签时显示同步通知</li>
            <li>✅ 服务器上对应书签被成功删除</li>
            <li>✅ 删除其他文件夹的书签不会触发同步</li>
            <li>✅ 批量删除时每个书签都会同步</li>
            <li>✅ 网络错误时显示错误通知</li>
            <li>✅ 控制台显示详细的调试信息</li>
        </ul>
    </div>

    <div class="test-section info">
        <h2>📊 测试数据</h2>
        
        <h3>测试书签示例</h3>
        <div class="code-block">
测试书签1:
- 标题: "Google搜索"
- URL: "https://www.google.com"
- 文件夹: "同步收藏夹"

测试书签2:
- 标题: "GitHub"
- URL: "https://github.com"
- 文件夹: "同步收藏夹 > 工作 > 开发工具"

测试书签3:
- 标题: "Stack Overflow"
- URL: "https://stackoverflow.com"
- 文件夹: "同步收藏夹 > 学习 > 技术问答"
        </div>

        <h3>验证方法</h3>
        <ol>
            <li><strong>前端验证</strong>：在Web管理界面查看书签列表</li>
            <li><strong>API验证</strong>：直接调用GET /bookmarks API</li>
            <li><strong>数据库验证</strong>：查询数据库bookmarks表</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>🚀 高级测试</h2>
        
        <h3>并发删除测试</h3>
        <ol class="step-list">
            <li>快速连续删除多个书签</li>
            <li>观察是否所有删除都能正确同步</li>
            <li>检查是否有API调用冲突</li>
        </ol>

        <h3>网络异常测试</h3>
        <ol class="step-list">
            <li>断开网络连接</li>
            <li>删除书签</li>
            <li>观察错误处理</li>
            <li>恢复网络后检查数据一致性</li>
        </ol>

        <h3>权限测试</h3>
        <ol class="step-list">
            <li>使用过期token删除书签</li>
            <li>观察权限错误处理</li>
            <li>重新登录后重试</li>
        </ol>
    </div>

    <div class="test-section success">
        <h2>🎉 测试完成标准</h2>
        
        <h3>✅ 基础功能</h3>
        <ul>
            <li>单个书签删除同步正常</li>
            <li>多级文件夹书签删除同步正常</li>
            <li>批量删除同步正常</li>
            <li>文件夹删除同步正常</li>
        </ul>

        <h3>✅ 错误处理</h3>
        <ul>
            <li>网络错误时显示错误信息</li>
            <li>权限错误时提示重新登录</li>
            <li>API错误时显示具体错误</li>
            <li>未登录时跳过同步</li>
        </ul>

        <h3>✅ 用户体验</h3>
        <ul>
            <li>删除操作响应迅速</li>
            <li>同步通知及时显示</li>
            <li>错误信息清晰明确</li>
            <li>调试信息详细完整</li>
        </ul>
    </div>

    <div class="test-section info">
        <h2>🔗 相关功能</h2>
        <ul>
            <li><strong>同步保存</strong>：收藏书签时自动上传到服务器</li>
            <li><strong>同步移动</strong>：移动书签时自动同步</li>
            <li><strong>同步更新</strong>：修改书签时自动更新服务器</li>
            <li><strong>导出导入</strong>：批量同步书签数据</li>
        </ul>
    </div>
</body>
</html>