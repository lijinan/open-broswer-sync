<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocketå¹¿æ’­æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .connection {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ WebSocketå¹¿æ’­æµ‹è¯•</h1>
        
        <p><strong>ç›®çš„</strong>: æµ‹è¯•WebSocketæœåŠ¡æ˜¯å¦èƒ½æ­£ç¡®å¹¿æ’­ä¹¦ç­¾å˜æ›´é€šçŸ¥</p>
        
        <div class="connection">
            <h3>è¿æ¥1 (æ¨¡æ‹ŸFirefox)</h3>
            <button onclick="connect1()">è¿æ¥</button>
            <button onclick="disconnect1()">æ–­å¼€</button>
            <button onclick="createBookmark1()">åˆ›å»ºä¹¦ç­¾</button>
            <div>çŠ¶æ€: <span id="status1">æœªè¿æ¥</span></div>
        </div>
        
        <div class="connection">
            <h3>è¿æ¥2 (æ¨¡æ‹ŸChrome)</h3>
            <button onclick="connect2()">è¿æ¥</button>
            <button onclick="disconnect2()">æ–­å¼€</button>
            <div>çŠ¶æ€: <span id="status2">æœªè¿æ¥</span></div>
        </div>
        
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        
        <div id="logContainer" class="log"></div>
    </div>

    <script>
        let ws1 = null;
        let ws2 = null;
        let logContainer;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            log('ğŸ“„ WebSocketå¹¿æ’­æµ‹è¯•å·¥å…·å·²åŠ è½½');
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(message);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateStatus(id, status) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = status;
            }
        }

        // è¿æ¥1 (æ¨¡æ‹ŸFirefox)
        async function connect1() {
            try {
                // è·å–token (éœ€è¦å…ˆåœ¨æ‰©å±•ä¸­ç™»å½•)
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ è¿æ¥1å¤±è´¥: æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•æ‰©å±•');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                const wsUrl = serverUrl.replace('http', 'ws') + `/ws?token=${settings.token}`;
                
                log('ğŸ”„ è¿æ¥1: è¿æ¥åˆ° ' + wsUrl);
                
                ws1 = new WebSocket(wsUrl);
                
                ws1.onopen = () => {
                    log('âœ… è¿æ¥1: WebSocketè¿æ¥æˆåŠŸ');
                    updateStatus('status1', 'å·²è¿æ¥');
                    
                    // è®¢é˜…ä¹¦ç­¾æ›´æ–°
                    ws1.send(JSON.stringify({
                        type: 'subscribe',
                        subscriptions: ['bookmarks']
                    }));
                };
                
                ws1.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log('ğŸ“¨ è¿æ¥1æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(message));
                };
                
                ws1.onclose = (event) => {
                    log('ğŸ”Œ è¿æ¥1å…³é—­: ' + event.code + ' - ' + event.reason);
                    updateStatus('status1', 'å·²æ–­å¼€');
                };
                
                ws1.onerror = (error) => {
                    log('âŒ è¿æ¥1é”™è¯¯: ' + error);
                    updateStatus('status1', 'é”™è¯¯');
                };
                
            } catch (error) {
                log('âŒ è¿æ¥1å¤±è´¥: ' + error.message);
            }
        }

        // è¿æ¥2 (æ¨¡æ‹ŸChrome)
        async function connect2() {
            try {
                // è·å–token
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ è¿æ¥2å¤±è´¥: æœªæ‰¾åˆ°tokenï¼Œè¯·å…ˆç™»å½•æ‰©å±•');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                const wsUrl = serverUrl.replace('http', 'ws') + `/ws?token=${settings.token}`;
                
                log('ğŸ”„ è¿æ¥2: è¿æ¥åˆ° ' + wsUrl);
                
                ws2 = new WebSocket(wsUrl);
                
                ws2.onopen = () => {
                    log('âœ… è¿æ¥2: WebSocketè¿æ¥æˆåŠŸ');
                    updateStatus('status2', 'å·²è¿æ¥');
                    
                    // è®¢é˜…ä¹¦ç­¾æ›´æ–°
                    ws2.send(JSON.stringify({
                        type: 'subscribe',
                        subscriptions: ['bookmarks']
                    }));
                };
                
                ws2.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log('ğŸ“¨ è¿æ¥2æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(message));
                    
                    if (message.type === 'bookmark_change') {
                        log('ğŸ‰ è¿æ¥2æ”¶åˆ°ä¹¦ç­¾å˜æ›´é€šçŸ¥: ' + message.action + ' - ' + message.data.title);
                    }
                };
                
                ws2.onclose = (event) => {
                    log('ğŸ”Œ è¿æ¥2å…³é—­: ' + event.code + ' - ' + event.reason);
                    updateStatus('status2', 'å·²æ–­å¼€');
                };
                
                ws2.onerror = (error) => {
                    log('âŒ è¿æ¥2é”™è¯¯: ' + error);
                    updateStatus('status2', 'é”™è¯¯');
                };
                
            } catch (error) {
                log('âŒ è¿æ¥2å¤±è´¥: ' + error.message);
            }
        }

        // æ–­å¼€è¿æ¥1
        function disconnect1() {
            if (ws1) {
                ws1.close();
                ws1 = null;
                log('ğŸ”Œ è¿æ¥1å·²æ–­å¼€');
            }
        }

        // æ–­å¼€è¿æ¥2
        function disconnect2() {
            if (ws2) {
                ws2.close();
                ws2 = null;
                log('ğŸ”Œ è¿æ¥2å·²æ–­å¼€');
            }
        }

        // é€šè¿‡è¿æ¥1åˆ›å»ºä¹¦ç­¾ (æ¨¡æ‹ŸFirefoxæ“ä½œ)
        async function createBookmark1() {
            try {
                log('ğŸ“š è¿æ¥1: åˆ›å»ºæµ‹è¯•ä¹¦ç­¾...');
                
                const settings = await chrome.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ åˆ›å»ºä¹¦ç­¾å¤±è´¥: æœªæ‰¾åˆ°token');
                    return;
                }
                
                const bookmarkData = {
                    title: `æµ‹è¯•ä¹¦ç­¾ ${new Date().toLocaleTimeString()}`,
                    url: `https://example.com/test-${Date.now()}`,
                    folder: 'åŒæ­¥æ”¶è—å¤¹',
                    tags: ['æµ‹è¯•', 'WebSocket']
                };
                
                const response = await fetch(`${settings.serverUrl}/bookmarks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.token}`
                    },
                    body: JSON.stringify(bookmarkData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('âœ… è¿æ¥1: ä¹¦ç­¾åˆ›å»ºæˆåŠŸ - ' + result.bookmark.title);
                    log('ğŸ’¡ è¿æ¥2åº”è¯¥æ”¶åˆ°WebSocketé€šçŸ¥');
                } else {
                    log('âŒ è¿æ¥1: ä¹¦ç­¾åˆ›å»ºå¤±è´¥ - ' + response.status);
                }
                
            } catch (error) {
                log('âŒ è¿æ¥1: åˆ›å»ºä¹¦ç­¾å¤±è´¥ - ' + error.message);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('ğŸ“„ æ—¥å¿—å·²æ¸…ç©º');
        }
    </script>
</body>
</html>