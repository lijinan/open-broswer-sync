<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefoxæ‰©å±•æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success { background-color: #d4edda; color: #155724; }
        .status.error { background-color: #f8d7da; color: #721c24; }
        .status.info { background-color: #d1ecf1; color: #0c5460; }
        .status.warning { background-color: #fff3cd; color: #856404; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .firefox-specific {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦Š Firefoxæ‰©å±•æµ‹è¯•å·¥å…·</h1>
        
        <div class="firefox-specific">
            <h4>ğŸ¦Š Firefoxæ‰©å±•å†…ç½®æµ‹è¯•</h4>
            <p>æ­¤é¡µé¢åœ¨Firefoxæ‰©å±•å†…è¿è¡Œï¼Œå¯ä»¥ç›´æ¥è®¿é—®æµè§ˆå™¨API</p>
        </div>
        
        <div id="status" class="status info">
            å‡†å¤‡æµ‹è¯•Firefoxæ‰©å±•åŠŸèƒ½...
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ åŸºç¡€æµ‹è¯•</h3>
            <button onclick="checkExtensionEnvironment()">æ£€æŸ¥æ‰©å±•ç¯å¢ƒ</button>
            <button onclick="testUserInfo()">æµ‹è¯•ç”¨æˆ·ä¿¡æ¯</button>
            <button onclick="testWebSocketConnection()">æµ‹è¯•WebSocketè¿æ¥</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“š ä¹¦ç­¾æµ‹è¯•</h3>
            <button onclick="createTestBookmark()">åˆ›å»ºæµ‹è¯•ä¹¦ç­¾</button>
            <button onclick="moveTestBookmark()">ç§»åŠ¨æµ‹è¯•ä¹¦ç­¾</button>
            <button onclick="updateTestBookmark()">æ›´æ–°ä¹¦ç­¾æ ‡é¢˜</button>
            <button onclick="deleteTestBookmark()">åˆ é™¤æµ‹è¯•ä¹¦ç­¾</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”„ åŒæ­¥æµ‹è¯•</h3>
            <button onclick="testBookmarkSync()">æµ‹è¯•ä¹¦ç­¾åŒæ­¥</button>
            <button onclick="testCrossBrowserSync()">æµ‹è¯•è·¨æµè§ˆå™¨åŒæ­¥</button>
            <button onclick="performFullSync()">æ‰§è¡Œå…¨é‡åŒæ­¥</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="logContainer" class="log"></div>
        </div>
    </div>

    <script>
        let logContainer;
        let statusDiv;
        let testBookmarkId = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('logContainer');
            statusDiv = document.getElementById('status');
            log('ğŸ“„ Firefoxæ‰©å±•æµ‹è¯•å·¥å…·å·²åŠ è½½');
            
            // è‡ªåŠ¨æ£€æŸ¥æ‰©å±•ç¯å¢ƒ
            setTimeout(checkExtensionEnvironment, 1000);
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            
            if (logContainer) {
                logContainer.textContent += logMessage;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            console.log(message);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, type = 'info') {
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
            }
        }

        // æ£€æŸ¥æ‰©å±•ç¯å¢ƒ
        async function checkExtensionEnvironment() {
            try {
                log('ğŸ” æ£€æŸ¥Firefoxæ‰©å±•ç¯å¢ƒ...');
                
                // æ£€æŸ¥browser API
                if (typeof browser !== 'undefined') {
                    log('âœ… æ£€æµ‹åˆ°Firefox browser API');
                    
                    // æ£€æŸ¥æ‰©å±•ID
                    const manifest = browser.runtime.getManifest();
                    log('ğŸ“‹ æ‰©å±•ä¿¡æ¯: ' + manifest.name + ' v' + manifest.version);
                    
                    // æ£€æŸ¥æƒé™
                    const permissions = manifest.permissions;
                    log('ğŸ” æ‰©å±•æƒé™: ' + permissions.join(', '));
                    
                    updateStatus('Firefoxæ‰©å±•ç¯å¢ƒæ­£å¸¸', 'success');
                } else if (typeof chrome !== 'undefined') {
                    log('âœ… æ£€æµ‹åˆ°Chrome API (å…¼å®¹æ¨¡å¼)');
                    updateStatus('Chrome APIå…¼å®¹æ¨¡å¼', 'warning');
                } else {
                    log('âŒ æœªæ£€æµ‹åˆ°æµè§ˆå™¨æ‰©å±•API');
                    updateStatus('æ‰©å±•APIä¸å¯ç”¨', 'error');
                    return;
                }
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const response = await browser.runtime.sendMessage({
                    type: 'CHECK_LOGIN_STATUS'
                });
                
                if (response && response.loggedIn) {
                    log('âœ… ç”¨æˆ·å·²ç™»å½•: ' + response.user.name);
                    updateStatus('ç”¨æˆ·å·²ç™»å½•ï¼Œæ‰©å±•åŠŸèƒ½æ­£å¸¸', 'success');
                } else {
                    log('âŒ ç”¨æˆ·æœªç™»å½•');
                    updateStatus('è¯·å…ˆç™»å½•æ‰©å±•', 'warning');
                }
                
            } catch (error) {
                log('âŒ æ£€æŸ¥æ‰©å±•ç¯å¢ƒå¤±è´¥: ' + error.message);
                updateStatus('æ£€æŸ¥æ‰©å±•ç¯å¢ƒå¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·ä¿¡æ¯
        async function testUserInfo() {
            try {
                log('ğŸ‘¤ æµ‹è¯•ç”¨æˆ·ä¿¡æ¯...');
                
                const settings = await browser.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ æœªæ‰¾åˆ°token');
                    updateStatus('è¯·å…ˆç™»å½•', 'error');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                
                const response = await fetch(`${serverUrl}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${settings.token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ');
                    log('ğŸ‘¤ ç”¨æˆ·: ' + JSON.stringify(data.user));
                    updateStatus('ç”¨æˆ·ä¿¡æ¯æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    log('âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥: ' + response.status);
                    updateStatus('ç”¨æˆ·ä¿¡æ¯æµ‹è¯•å¤±è´¥', 'error');
                }
                
            } catch (error) {
                log('âŒ æµ‹è¯•ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message);
                updateStatus('ç”¨æˆ·ä¿¡æ¯æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•WebSocketè¿æ¥
        async function testWebSocketConnection() {
            try {
                log('ğŸ“¡ æµ‹è¯•WebSocketè¿æ¥...');
                
                const settings = await browser.storage.sync.get(['token', 'serverUrl']);
                if (!settings.token) {
                    log('âŒ æœªæ‰¾åˆ°token');
                    updateStatus('è¯·å…ˆç™»å½•', 'error');
                    return;
                }
                
                const serverUrl = settings.serverUrl || 'http://localhost:3001';
                const wsUrl = serverUrl.replace('http', 'ws') + `/ws?token=${settings.token}`;
                
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    updateStatus('WebSocketè¿æ¥æµ‹è¯•é€šè¿‡', 'success');
                    
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    ws.send(JSON.stringify({
                        type: 'ping',
                        message: 'Firefoxæ‰©å±•æµ‹è¯•'
                    }));
                };
                
                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message.type}`);
                    if (message.user) {
                        log(`ğŸ‘¤ è¿æ¥ç”¨æˆ·: ${message.user.name} (ID: ${message.user.id})`);
                    }
                };
                
                ws.onclose = () => {
                    log('ğŸ”Œ WebSocketè¿æ¥å…³é—­');
                };
                
                ws.onerror = (error) => {
                    log('âŒ WebSocketé”™è¯¯: ' + error);
                    updateStatus('WebSocketè¿æ¥å¤±è´¥', 'error');
                };
                
                // 5ç§’åå…³é—­è¿æ¥
                setTimeout(() => {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.close();
                    }
                }, 5000);
                
            } catch (error) {
                log('âŒ WebSocketè¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                updateStatus('WebSocketè¿æ¥æµ‹è¯•å¤±è´¥', 'error');
            }
        }

        // åˆ›å»ºæµ‹è¯•ä¹¦ç­¾
        async function createTestBookmark() {
            try {
                log('ğŸ“š åˆ›å»ºFirefoxæµ‹è¯•ä¹¦ç­¾...');
                
                // æ‰¾åˆ°æˆ–åˆ›å»ºåŒæ­¥æ”¶è—å¤¹
                let syncFolders = await browser.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' });
                let syncFolder;
                
                if (syncFolders.length === 0) {
                    syncFolder = await browser.bookmarks.create({
                        title: 'åŒæ­¥æ”¶è—å¤¹'
                    });
                    log('âœ… åˆ›å»ºåŒæ­¥æ”¶è—å¤¹: ' + syncFolder.id);
                } else {
                    syncFolder = syncFolders[0];
                    log('âœ… æ‰¾åˆ°åŒæ­¥æ”¶è—å¤¹: ' + syncFolder.id);
                }
                
                // åˆ›å»ºæµ‹è¯•ä¹¦ç­¾
                const testBookmark = await browser.bookmarks.create({
                    parentId: syncFolder.id,
                    title: 'Firefoxæ‰©å±•æµ‹è¯•ä¹¦ç­¾-' + new Date().getTime(),
                    url: 'https://firefox-extension-test.example.com'
                });
                
                testBookmarkId = testBookmark.id;
                log('âœ… æµ‹è¯•ä¹¦ç­¾åˆ›å»ºæˆåŠŸ: ' + testBookmark.title);
                log('ğŸ“ ä¹¦ç­¾ID: ' + testBookmark.id);
                updateStatus('æµ‹è¯•ä¹¦ç­¾åˆ›å»ºæˆåŠŸ', 'success');
                
                // ç­‰å¾…åŒæ­¥
                setTimeout(() => {
                    log('ğŸ’¡ è¯·æ£€æŸ¥Chromeæ˜¯å¦æ”¶åˆ°ä¹¦ç­¾åˆ›å»ºé€šçŸ¥');
                }, 3000);
                
            } catch (error) {
                log('âŒ åˆ›å»ºæµ‹è¯•ä¹¦ç­¾å¤±è´¥: ' + error.message);
                updateStatus('åˆ›å»ºæµ‹è¯•ä¹¦ç­¾å¤±è´¥', 'error');
            }
        }

        // ç§»åŠ¨æµ‹è¯•ä¹¦ç­¾
        async function moveTestBookmark() {
            try {
                if (!testBookmarkId) {
                    log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç­¾');
                    updateStatus('è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç­¾', 'error');
                    return;
                }
                
                log('ğŸ“ ç§»åŠ¨Firefoxæµ‹è¯•ä¹¦ç­¾...');
                
                const syncFolders = await browser.bookmarks.search({ title: 'åŒæ­¥æ”¶è—å¤¹' });
                const syncFolder = syncFolders[0];
                
                // åˆ›å»ºæµ‹è¯•æ–‡ä»¶å¤¹
                let testFolder;
                const existingFolders = await browser.bookmarks.getChildren(syncFolder.id);
                const existingTestFolder = existingFolders.find(child => 
                    !child.url && child.title === 'Firefoxæ‰©å±•æµ‹è¯•æ–‡ä»¶å¤¹'
                );
                
                if (existingTestFolder) {
                    testFolder = existingTestFolder;
                } else {
                    testFolder = await browser.bookmarks.create({
                        parentId: syncFolder.id,
                        title: 'Firefoxæ‰©å±•æµ‹è¯•æ–‡ä»¶å¤¹'
                    });
                }
                
                // ç§»åŠ¨ä¹¦ç­¾
                await browser.bookmarks.move(testBookmarkId, {
                    parentId: testFolder.id
                });
                
                log('âœ… ä¹¦ç­¾ç§»åŠ¨æˆåŠŸ');
                updateStatus('ä¹¦ç­¾ç§»åŠ¨æµ‹è¯•é€šè¿‡', 'success');
                
                setTimeout(() => {
                    log('ğŸ’¡ è¯·æ£€æŸ¥Chromeæ˜¯å¦æ”¶åˆ°ä¹¦ç­¾ç§»åŠ¨é€šçŸ¥');
                }, 3000);
                
            } catch (error) {
                log('âŒ ç§»åŠ¨æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ' + error.message);
                updateStatus('ç§»åŠ¨æµ‹è¯•ä¹¦ç­¾å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°æµ‹è¯•ä¹¦ç­¾
        async function updateTestBookmark() {
            try {
                if (!testBookmarkId) {
                    log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç­¾');
                    updateStatus('è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç­¾', 'error');
                    return;
                }
                
                log('âœï¸ æ›´æ–°Firefoxæµ‹è¯•ä¹¦ç­¾...');
                
                const newTitle = 'Firefoxæ‰©å±•æµ‹è¯•ä¹¦ç­¾-å·²æ›´æ–°-' + new Date().getTime();
                await browser.bookmarks.update(testBookmarkId, {
                    title: newTitle
                });
                
                log('âœ… ä¹¦ç­¾æ ‡é¢˜æ›´æ–°æˆåŠŸ: ' + newTitle);
                updateStatus('ä¹¦ç­¾æ›´æ–°æµ‹è¯•é€šè¿‡', 'success');
                
                setTimeout(() => {
                    log('ğŸ’¡ è¯·æ£€æŸ¥Chromeæ˜¯å¦æ”¶åˆ°ä¹¦ç­¾æ›´æ–°é€šçŸ¥');
                }, 3000);
                
            } catch (error) {
                log('âŒ æ›´æ–°æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ' + error.message);
                updateStatus('æ›´æ–°æµ‹è¯•ä¹¦ç­¾å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤æµ‹è¯•ä¹¦ç­¾
        async function deleteTestBookmark() {
            try {
                if (!testBookmarkId) {
                    log('âŒ è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç­¾');
                    updateStatus('è¯·å…ˆåˆ›å»ºæµ‹è¯•ä¹¦ç­¾', 'error');
                    return;
                }
                
                log('ğŸ—‘ï¸ åˆ é™¤Firefoxæµ‹è¯•ä¹¦ç­¾...');
                
                await browser.bookmarks.remove(testBookmarkId);
                
                log('âœ… æµ‹è¯•ä¹¦ç­¾åˆ é™¤æˆåŠŸ');
                updateStatus('ä¹¦ç­¾åˆ é™¤æµ‹è¯•é€šè¿‡', 'success');
                
                testBookmarkId = null;
                
                setTimeout(() => {
                    log('ğŸ’¡ è¯·æ£€æŸ¥Chromeæ˜¯å¦æ”¶åˆ°ä¹¦ç­¾åˆ é™¤é€šçŸ¥');
                }, 3000);
                
            } catch (error) {
                log('âŒ åˆ é™¤æµ‹è¯•ä¹¦ç­¾å¤±è´¥: ' + error.message);
                updateStatus('åˆ é™¤æµ‹è¯•ä¹¦ç­¾å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•ä¹¦ç­¾åŒæ­¥
        async function testBookmarkSync() {
            log('ğŸ”„ å¼€å§‹ä¹¦ç­¾åŒæ­¥æµ‹è¯•...');
            await createTestBookmark();
            
            setTimeout(async () => {
                await moveTestBookmark();
                
                setTimeout(async () => {
                    await updateTestBookmark();
                    
                    setTimeout(async () => {
                        await deleteTestBookmark();
                        log('âœ… ä¹¦ç­¾åŒæ­¥æµ‹è¯•å®Œæˆ');
                    }, 3000);
                }, 3000);
            }, 3000);
        }

        // æµ‹è¯•è·¨æµè§ˆå™¨åŒæ­¥
        async function testCrossBrowserSync() {
            log('ğŸŒ æµ‹è¯•è·¨æµè§ˆå™¨åŒæ­¥...');
            log('ğŸ’¡ è¯·åœ¨Chromeä¸­è¿›è¡Œä¹¦ç­¾æ“ä½œï¼Œè§‚å¯ŸFirefoxæ˜¯å¦æ”¶åˆ°åŒæ­¥');
            updateStatus('è¯·åœ¨Chromeä¸­æ“ä½œä¹¦ç­¾ï¼Œè§‚å¯ŸåŒæ­¥æ•ˆæœ', 'info');
        }

        // æ‰§è¡Œå…¨é‡åŒæ­¥
        async function performFullSync() {
            try {
                log('ğŸ”„ æ‰§è¡Œå…¨é‡åŒæ­¥...');
                
                const response = await browser.runtime.sendMessage({
                    type: 'PERFORM_FULL_SYNC'
                });
                
                if (response && response.success) {
                    log('âœ… å…¨é‡åŒæ­¥æ‰§è¡ŒæˆåŠŸ');
                    updateStatus('å…¨é‡åŒæ­¥å®Œæˆ', 'success');
                } else {
                    log('âŒ å…¨é‡åŒæ­¥æ‰§è¡Œå¤±è´¥');
                    updateStatus('å…¨é‡åŒæ­¥å¤±è´¥', 'error');
                }
                
            } catch (error) {
                log('âŒ æ‰§è¡Œå…¨é‡åŒæ­¥å¤±è´¥: ' + error.message);
                updateStatus('å…¨é‡åŒæ­¥å¤±è´¥', 'error');
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            if (logContainer) {
                logContainer.textContent = '';
            }
            log('ğŸ“„ æ—¥å¿—å·²æ¸…ç©º');
        }
    </script>
</body>
</html>